<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LifeVault â€” Your Personal Space</title>
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Newsreader:ital,opsz,wght@0,6..72,300;0,6..72,400;1,6..72,300;1,6..72,400&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0b0f1a;--surface:#111827;--surface2:#1a2235;--border:rgba(255,255,255,0.07);
  --text:#e8eaf0;--muted:#6b7a99;--accent:#4f8ef7;--green:#34d399;--amber:#fbbf24;
  --rose:#f87171;--lavender:#a78bfa;--teal:#2dd4bf;--glow:0 0 40px rgba(79,142,247,0.15);
}
*{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:'Syne',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background-image:linear-gradient(rgba(79,142,247,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(79,142,247,0.03) 1px,transparent 1px);background-size:40px 40px}

/* â”€â”€ LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#loading{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;gap:20px;transition:opacity .5s,visibility .5s}
#loading.hidden{opacity:0;visibility:hidden}
.loader-logo{font-size:2.2rem;font-weight:800;letter-spacing:-.03em;background:linear-gradient(135deg,var(--accent),var(--lavender));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.loader-bar{width:180px;height:2px;background:var(--surface2);border-radius:99px;overflow:hidden}
.loader-bar::after{content:'';display:block;height:100%;width:40%;background:linear-gradient(90deg,var(--accent),var(--lavender));border-radius:99px;animation:loadSlide 1.2s ease-in-out infinite}

/* â”€â”€ ANIMATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes loadSlide{0%{transform:translateX(-100%)}100%{transform:translateX(350%)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(30px) scale(.96)}to{opacity:1;transform:translateY(0) scale(1)}}
@keyframes pageIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes modalIn{from{opacity:0;transform:scale(.92) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}
@keyframes toastIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
@keyframes toastOut{to{opacity:0;transform:translateX(20px)}}
@keyframes heartBeat{0%{transform:scale(1)}40%{transform:scale(1.4)}70%{transform:scale(.9)}100%{transform:scale(1)}}
@keyframes slideDown{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(.85)}}
@keyframes overlayFadeIn{from{opacity:0}to{opacity:1}}
@keyframes expandCardIn{from{opacity:0;transform:scale(.88) translateY(24px)}to{opacity:1;transform:scale(1) translateY(0)}}

/* â”€â”€ JOURNAL EXPAND OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.journal-expand-overlay{position:fixed;inset:0;background:rgba(11,15,26,0);z-index:300;display:none;align-items:center;justify-content:center;padding:24px}
.journal-expand-overlay.open{display:flex;background:rgba(11,15,26,.92);animation:overlayFadeIn .3s ease both}
.journal-expanded-card{background:var(--surface);border:1px solid rgba(79,142,247,.25);border-radius:20px;max-width:680px;width:100%;max-height:88vh;display:flex;flex-direction:column;box-shadow:0 0 80px rgba(79,142,247,.12),0 40px 80px rgba(0,0,0,.6);animation:expandCardIn .38s cubic-bezier(.34,1.4,.64,1) both;overflow:hidden}
.expanded-card-header{padding:24px 28px 18px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-shrink:0;background:linear-gradient(135deg,rgba(79,142,247,.06),rgba(167,139,250,.04))}
.expanded-card-title{font-size:1.25rem;font-weight:800;letter-spacing:-.03em;line-height:1.3;flex:1}
.expanded-card-meta{display:flex;align-items:center;gap:10px;margin-top:6px}
.expanded-card-date{font-family:'JetBrains Mono',monospace;font-size:.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:.1em}
.expanded-mood-badge{font-size:1.3rem;line-height:1}
.expanded-close-btn{background:var(--surface2);border:1px solid var(--border);color:var(--muted);cursor:pointer;font-size:.9rem;width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;transition:color .2s,background .2s,border-color .2s;flex-shrink:0}
.expanded-close-btn:hover{color:var(--rose);border-color:var(--rose);background:rgba(248,113,113,.08)}
.expanded-card-body{padding:24px 28px;overflow-y:auto;flex:1}
.expanded-card-content{font-family:'Newsreader',serif;font-size:1rem;line-height:1.85;color:rgba(232,234,240,.85);font-weight:300;white-space:pre-wrap;word-break:break-word}
.expanded-photos{display:flex;gap:10px;flex-wrap:wrap;margin-top:20px;padding-top:20px;border-top:1px solid var(--border)}
.expanded-photo{width:120px;height:120px;border-radius:10px;object-fit:cover;border:1px solid var(--border);cursor:pointer;transition:transform .2s,border-color .2s}
.expanded-photo:hover{transform:scale(1.04);border-color:var(--accent)}
.expanded-tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:20px;padding-top:20px;border-top:1px solid var(--border)}
.expanded-card-footer{padding:16px 28px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:flex-end;gap:10px;flex-shrink:0;background:var(--surface2)}

/* â”€â”€ JOURNAL ENTRIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.journal-entry{padding:18px;background:var(--surface2);border-radius:12px;margin-bottom:12px;border:1px solid var(--border);transition:border-color .2s,transform .2s,box-shadow .2s;cursor:pointer;position:relative;user-select:none}
.journal-entry:hover{border-color:rgba(79,142,247,.35);transform:translateX(4px) scale(1.01);box-shadow:0 4px 24px rgba(79,142,247,.1)}
.journal-entry-actions{display:flex;align-items:center;gap:4px}
.journal-entry-actions button{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.8rem;padding:5px 7px;border-radius:6px;transition:color .2s,background .2s;line-height:1}
.journal-entry-actions button:hover{color:var(--accent);background:rgba(79,142,247,.1)}
.journal-entry-actions button.del-btn:hover{color:var(--rose);background:rgba(248,113,113,.1)}
.entry-expand-hint{font-size:.6rem;color:var(--muted);font-family:'JetBrains Mono',monospace;opacity:.5;margin-top:8px;letter-spacing:.05em}
.entry-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;gap:8px}
.entry-date{font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:.1em}
.mood-emoji{font-size:1.1rem}
.entry-preview{font-family:'Newsreader',serif;font-size:.9rem;color:rgba(232,234,240,.7);line-height:1.6;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;font-weight:300}
.entry-tags{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
.tag{font-family:'JetBrains Mono',monospace;font-size:.58rem;padding:2px 8px;border-radius:4px;text-transform:uppercase;letter-spacing:.08em}

/* â”€â”€ MOBILE HAMBURGER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hamburger{display:none;position:fixed;top:14px;left:14px;z-index:52;background:var(--surface);border:1px solid var(--border);border-radius:10px;width:40px;height:40px;align-items:center;justify-content:center;cursor:pointer;flex-direction:column;gap:5px;padding:10px;transition:all .25s}
.hamburger:hover{border-color:var(--accent)}
.hamburger span{display:block;width:18px;height:1.5px;background:var(--text);border-radius:2px;transition:all .25s}
.hamburger.open{opacity:0;pointer-events:none;transform:scale(0.8)}
.sidebar-overlay{display:none;position:fixed;inset:0;background:transparent;z-index:49}
.sidebar-overlay.open{display:block}

/* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#auth-screen{display:none;min-height:100vh;align-items:center;justify-content:center;flex-direction:column;gap:40px;padding:40px;position:relative;z-index:1}
.auth-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:52px 48px;max-width:440px;width:100%;text-align:center;box-shadow:var(--glow),0 40px 80px rgba(0,0,0,.4);animation:fadeUp .6s cubic-bezier(.34,1.56,.64,1) both}
.auth-logo{font-size:2.6rem;font-weight:800;letter-spacing:-.04em;background:linear-gradient(135deg,var(--accent) 0%,var(--lavender) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
.auth-tagline{font-family:'Newsreader',serif;font-style:italic;font-size:1rem;color:var(--muted);margin-bottom:36px;font-weight:300}
.auth-features{display:flex;flex-direction:column;gap:12px;margin-bottom:36px;text-align:left}
.auth-feature{display:flex;align-items:center;gap:12px;font-size:.82rem;color:var(--muted)}
.auth-feature-icon{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.85rem;flex-shrink:0}
.google-btn{width:100%;padding:14px;background:white;color:#1a1a1a;border:none;border-radius:10px;font-family:'Syne',sans-serif;font-size:.9rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:transform .2s,box-shadow .2s}
.google-btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.3)}
.google-icon{width:18px;height:18px}
.privacy-note{font-family:'JetBrains Mono',monospace;font-size:.62rem;color:var(--muted);margin-top:16px;opacity:.6}
#app{display:none;min-height:100vh;position:relative;z-index:1}
.sidebar{position:fixed;left:0;top:0;bottom:0;width:260px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:51;padding:28px 0;transition:transform .3s cubic-bezier(.4,0,.2,1)}
.sidebar-close-btn{display:none;position:absolute;top:14px;right:12px;background:var(--surface2);border:1px solid var(--border);color:var(--muted);border-radius:8px;width:32px;height:32px;align-items:center;justify-content:center;cursor:pointer;font-size:.85rem;transition:color .2s,border-color .2s}
.sidebar-close-btn:hover{color:var(--rose);border-color:var(--rose)}
.sidebar-logo{padding:0 52px 20px 24px;font-size:1.4rem;font-weight:800;letter-spacing:-.03em;background:linear-gradient(135deg,var(--accent),var(--lavender));-webkit-background-clip:text;-webkit-text-fill-color:transparent;border-bottom:1px solid var(--border);margin-bottom:20px}
.nav-section-label{font-family:'JetBrains Mono',monospace;font-size:.58rem;text-transform:uppercase;letter-spacing:.18em;color:var(--muted);padding:0 24px 8px;margin-top:8px}
.nav-item{padding:10px 24px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all .18s;font-size:.85rem;font-weight:500;color:var(--muted);border-left:2px solid transparent;margin:1px 0}
.nav-item:hover{background:var(--surface2);color:var(--text)}
.nav-item.active{background:rgba(79,142,247,.1);color:var(--accent);border-left-color:var(--accent)}
.nav-icon{font-size:1rem;width:20px;text-align:center}
.sidebar-bottom{margin-top:auto;padding:20px 24px 0;border-top:1px solid var(--border)}
.user-card{display:flex;align-items:center;gap:10px}
.user-avatar{width:32px;height:32px;border-radius:50%;border:1.5px solid var(--accent);object-fit:cover}
.user-info{flex:1;min-width:0}
.user-name{font-size:.78rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.user-email{font-size:.62rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.signout-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.75rem;padding:4px;transition:color .2s}
.signout-btn:hover{color:var(--rose)}
.main{margin-left:240px;min-height:100vh;padding:32px 36px}
.page{display:none}
.page.active{display:block;animation:pageIn .3s ease both}
.page-header{margin-bottom:32px;display:flex;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;gap:16px}
.page-title{font-size:2rem;font-weight:800;letter-spacing:-.03em}
.page-subtitle{font-family:'Newsreader',serif;font-style:italic;font-size:.9rem;color:var(--muted);margin-top:4px;font-weight:300}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(175px,1fr));gap:16px;margin-bottom:32px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:22px;transition:transform .2s,border-color .2s}
.stat-card:hover{transform:translateY(-3px);border-color:rgba(79,142,247,.3)}
.stat-label{font-family:'JetBrains Mono',monospace;font-size:.62rem;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);margin-bottom:10px}
.stat-value{font-size:2rem;font-weight:800;letter-spacing:-.04em;line-height:1;margin-bottom:6px}
.stat-change{font-size:.72rem;color:var(--muted)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
@media(max-width:900px){.grid-2{grid-template-columns:1fr}}
.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px}
.card-title{font-size:.9rem;font-weight:700;margin-bottom:18px;display:flex;align-items:center;gap:8px}
.mood-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.mood-day-label{font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--muted);width:28px;text-align:right}
.mood-bar-wrap{flex:1;background:var(--surface2);height:8px;border-radius:99px;overflow:hidden}
.mood-bar{height:100%;border-radius:99px;transition:width .6s cubic-bezier(.34,1.56,.64,1)}
.mood-val{font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--muted);width:20px}
.task-item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);transition:opacity .2s}
.task-item:last-child{border-bottom:none}
.task-item.done{opacity:.45}
.task-check{width:18px;height:18px;border-radius:5px;border:1.5px solid var(--border);cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .18s;background:transparent}
.task-check.checked{background:var(--green);border-color:var(--green)}
.task-check.checked::after{content:'âœ“';font-size:.65rem;color:#0b0f1a;font-weight:700}
.task-text{flex:1;font-size:.84rem;line-height:1.4}
.task-item.done .task-text{text-decoration:line-through}
.priority-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.p-high{background:var(--rose)}.p-med{background:var(--amber)}.p-low{background:var(--green)}
.task-del,.task-edit{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.75rem;opacity:0;transition:opacity .2s,color .2s;padding:4px}
.task-item:hover .task-del,.task-item:hover .task-edit{opacity:1}
.task-del:hover{color:var(--rose)}.task-edit:hover{color:var(--accent)}
.btn{font-family:'Syne',sans-serif;font-size:.8rem;font-weight:600;padding:10px 18px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text);cursor:pointer;transition:all .18s;display:inline-flex;align-items:center;gap:6px}
.btn:hover{background:var(--surface);border-color:rgba(79,142,247,.3);color:var(--accent)}
.btn-primary{background:var(--accent);border-color:var(--accent);color:white}
.btn-primary:hover{background:#3a7ae0;border-color:#3a7ae0;color:white}
.btn-sm{font-family:'Syne',sans-serif;font-size:.72rem;font-weight:600;padding:5px 11px;border-radius:7px;border:1px solid var(--border);background:var(--surface);color:var(--muted);cursor:pointer;transition:all .18s}
.btn-sm:hover{color:var(--accent);border-color:var(--accent)}
.form-group{margin-bottom:16px}
.form-label{display:block;font-family:'JetBrains Mono',monospace;font-size:.65rem;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);margin-bottom:8px}
.form-input,.form-textarea,.form-select{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px 14px;color:var(--text);font-family:'Syne',sans-serif;font-size:.85rem;outline:none;transition:border-color .2s,box-shadow .2s}
.form-input:focus,.form-textarea:focus,.form-select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(79,142,247,.12)}
.form-textarea{resize:vertical;min-height:120px;line-height:1.6;font-family:'Newsreader',serif;font-size:.95rem;font-weight:300}
.form-select option{background:var(--surface)}
.mood-picker{display:flex;gap:8px;flex-wrap:wrap}
.mood-option{padding:8px 14px;border-radius:8px;border:1.5px solid var(--border);cursor:pointer;font-size:1.1rem;transition:all .18s;background:var(--surface2);display:flex;flex-direction:column;align-items:center;gap:2px}
.mood-option span{font-size:.55rem;font-family:'JetBrains Mono',monospace;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
.mood-option.selected{border-color:var(--accent);background:rgba(79,142,247,.12);transform:scale(1.05)}
.mood-option:hover{transform:scale(1.05)}
.modal-backdrop{position:fixed;inset:0;background:rgba(11,15,26,.92);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
.modal-backdrop.open{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:32px;max-width:520px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 40px 80px rgba(0,0,0,.5);animation:modalIn .3s cubic-bezier(.34,1.56,.64,1) both}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.modal-title{font-size:1.2rem;font-weight:800;letter-spacing:-.02em}
.modal-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.2rem;line-height:1;transition:color .2s;padding:4px}
.modal-close:hover{color:var(--rose)}
.streak-display{background:linear-gradient(135deg,rgba(79,142,247,.15),rgba(124,106,247,.15));border:1px solid rgba(79,142,247,.2);border-radius:16px;padding:24px;text-align:center;margin-bottom:20px}
.streak-number{font-size:4rem;font-weight:800;letter-spacing:-.05em;background:linear-gradient(135deg,var(--accent),var(--lavender));-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1;margin-bottom:4px}
.streak-label{font-family:'JetBrains Mono',monospace;font-size:.65rem;text-transform:uppercase;letter-spacing:.15em;color:var(--muted)}
.goal-item{padding:16px;background:var(--surface2);border-radius:12px;margin-bottom:10px;border:1px solid var(--border)}
.goal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.goal-name{font-size:.85rem;font-weight:600}
.goal-pct{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--accent)}
.goal-progress-wrap{background:var(--surface);height:6px;border-radius:99px;overflow:hidden}
.goal-progress-bar{height:100%;border-radius:99px;transition:width .5s ease}
.goal-actions{display:flex;gap:6px;margin-top:10px}
.toast-container{position:fixed;bottom:24px;right:24px;z-index:999;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 18px;font-size:.8rem;display:flex;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(0,0,0,.3);animation:toastIn .3s ease both;min-width:220px}
.toast.out{animation:toastOut .3s ease both}
.empty-state{text-align:center;padding:48px 24px;color:var(--muted)}
.empty-state .empty-icon{font-size:2.5rem;margin-bottom:12px}
.empty-state .empty-text{font-size:.85rem;margin-bottom:16px;font-family:'Newsreader',serif;font-style:italic}

/* â”€â”€ COMMUNITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.feed-container{max-width:680px;margin:0 auto}
.feed-composer{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:24px;transition:border-color .2s}
.feed-composer:focus-within{border-color:rgba(79,142,247,.35);box-shadow:0 0 0 3px rgba(79,142,247,.06)}
.composer-top{display:flex;gap:12px;align-items:flex-start}
.composer-avatar{width:40px;height:40px;border-radius:50%;border:1.5px solid var(--accent);object-fit:cover;flex-shrink:0}
.composer-input{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-family:'Newsreader',serif;font-size:.95rem;font-weight:300;line-height:1.6;resize:none;min-height:60px}
.composer-input::placeholder{color:var(--muted)}
.composer-bottom{display:flex;align-items:center;justify-content:space-between;margin-top:14px;padding-top:14px;border-top:1px solid var(--border)}
.composer-actions{display:flex;gap:6px;flex-wrap:wrap}
.composer-type-btn{padding:6px 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:.62rem;text-transform:uppercase;letter-spacing:.08em;cursor:pointer;transition:all .18s}
.composer-type-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(79,142,247,.1)}
.feed-filters{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
.feed-filter-btn{padding:7px 16px;border-radius:99px;border:1px solid var(--border);background:var(--surface2);color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:.62rem;text-transform:uppercase;letter-spacing:.08em;cursor:pointer;transition:all .2s}
.feed-filter-btn.active{background:var(--accent);border-color:var(--accent);color:white}
.feed-filter-btn:hover:not(.active){border-color:rgba(79,142,247,.3);color:var(--accent)}
.post-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:16px;transition:border-color .2s;animation:slideDown .3s ease both}
.post-card:hover{border-color:rgba(79,142,247,.15)}
.post-header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.post-avatar{width:38px;height:38px;border-radius:50%;object-fit:cover;border:1.5px solid var(--border);flex-shrink:0}
.post-meta{flex:1;min-width:0}
.post-author{font-size:.82rem;font-weight:700;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.post-type-badge{font-family:'JetBrains Mono',monospace;font-size:.55rem;text-transform:uppercase;letter-spacing:.1em;padding:2px 7px;border-radius:4px;font-weight:400}
.badge-journal{background:rgba(79,142,247,.15);color:var(--accent)}
.badge-task{background:rgba(52,211,153,.15);color:var(--green)}
.badge-goal{background:rgba(167,139,250,.15);color:var(--lavender)}
.post-time{font-family:'JetBrains Mono',monospace;font-size:.6rem;color:var(--muted)}
.post-title{font-size:.95rem;font-weight:700;letter-spacing:-.01em;margin-bottom:8px;line-height:1.3}
.post-body{font-family:'Newsreader',serif;font-size:.9rem;line-height:1.7;color:rgba(232,234,240,.75);font-weight:300;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden}
.post-body.expanded{-webkit-line-clamp:unset;overflow:visible}
.post-read-more{font-family:'JetBrains Mono',monospace;font-size:.62rem;color:var(--accent);cursor:pointer;margin-top:4px;display:inline-block}
.post-goal-bar{margin:10px 0;background:var(--surface2);border-radius:99px;height:6px;overflow:hidden}
.post-goal-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--accent),var(--lavender))}
.post-goal-meta{display:flex;justify-content:space-between;font-family:'JetBrains Mono',monospace;font-size:.62rem;color:var(--muted);margin-top:4px}
.post-photos{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.post-photo{width:100px;height:100px;border-radius:10px;object-fit:cover;border:1px solid var(--border);cursor:pointer;transition:transform .2s}
.post-photo:hover{transform:scale(1.04);border-color:var(--accent)}
.post-tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
.post-actions{display:flex;align-items:center;gap:4px;margin-top:16px;padding-top:14px;border-top:1px solid var(--border)}
.post-action-btn{display:flex;align-items:center;gap:6px;padding:7px 12px;border-radius:8px;border:none;background:transparent;color:var(--muted);cursor:pointer;font-family:'Syne',sans-serif;font-size:.75rem;font-weight:600;transition:all .18s}
.post-action-btn:hover{background:var(--surface2);color:var(--text)}
.post-action-btn.liked{color:var(--rose)}
.post-action-btn.liked .heart-icon{animation:heartBeat .4s ease}
.post-action-count{font-family:'JetBrains Mono',monospace;font-size:.68rem}
.post-delete-btn{margin-left:auto;padding:7px 12px;border-radius:8px;border:none;background:transparent;color:var(--muted);cursor:pointer;font-size:.75rem;transition:all .18s}
.post-delete-btn:hover{background:rgba(248,113,113,.1);color:var(--rose)}
.comments-section{margin-top:14px;padding-top:14px;border-top:1px solid var(--border)}
.comment-item{display:flex;gap:10px;margin-bottom:12px;animation:slideDown .25s ease both}
.comment-avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;flex-shrink:0;border:1px solid var(--border)}
.comment-bubble{background:var(--surface2);border-radius:0 10px 10px 10px;padding:10px 14px;flex:1}
.comment-author{font-size:.72rem;font-weight:700;margin-bottom:3px;display:flex;align-items:center;justify-content:space-between}
.comment-text{font-family:'Newsreader',serif;font-size:.82rem;line-height:1.5;color:rgba(232,234,240,.8);font-weight:300}
.comment-del{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.68rem;opacity:0;transition:opacity .2s,color .2s;padding:2px}
.comment-bubble:hover .comment-del{opacity:1}
.comment-del:hover{color:var(--rose)}
.comment-input-row{display:flex;gap:10px;align-items:center;margin-top:10px}
.comment-input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:9px 14px;color:var(--text);font-family:'Newsreader',serif;font-size:.82rem;outline:none;transition:border-color .2s;font-weight:300}
.comment-input:focus{border-color:var(--accent)}
.comment-submit{background:var(--accent);border:none;color:white;padding:9px 14px;border-radius:10px;cursor:pointer;font-size:.75rem;font-weight:700;font-family:'Syne',sans-serif}
.feed-empty{text-align:center;padding:60px 24px;color:var(--muted)}
.feed-empty .empty-icon{font-size:3rem;margin-bottom:16px}
.feed-empty .empty-title{font-size:1rem;font-weight:700;margin-bottom:8px}
.feed-empty .empty-sub{font-family:'Newsreader',serif;font-style:italic;font-size:.85rem;opacity:.7}
.loading-posts{text-align:center;padding:32px;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:.72rem}
.share-modal-items{display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto}
.share-item{display:flex;align-items:center;gap:12px;padding:12px;background:var(--surface2);border-radius:10px;border:1px solid var(--border);cursor:pointer;transition:all .18s}
.share-item:hover{border-color:rgba(79,142,247,.3);background:rgba(79,142,247,.06)}
.share-item-icon{font-size:1.2rem;flex-shrink:0}
.share-item-info{flex:1;min-width:0}
.share-item-title{font-size:.82rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.share-item-meta{font-size:.68rem;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-top:2px}
.community-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
.comm-stat{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center}
.comm-stat-val{font-size:1.6rem;font-weight:800;letter-spacing:-.04em;line-height:1;margin-bottom:4px}
.comm-stat-label{font-family:'JetBrains Mono',monospace;font-size:.58rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted)}
.notification-dot{width:8px;height:8px;background:var(--rose);border-radius:50%;display:inline-block;margin-left:4px;animation:pulse 2s infinite}

/* â”€â”€ PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.profile-cover{height:180px;border-radius:16px 16px 0 0;position:relative;overflow:hidden;cursor:pointer}
.profile-cover::before{content:'';position:absolute;inset:0;background-image:radial-gradient(circle at 30% 50%,rgba(255,255,255,.18) 0%,transparent 60%),radial-gradient(circle at 80% 20%,rgba(255,255,255,.1) 0%,transparent 50%)}
.profile-cover-edit{position:absolute;bottom:12px;right:12px;background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.15);color:var(--text);border-radius:8px;padding:6px 12px;font-size:.72rem;cursor:pointer;font-family:'Syne',sans-serif;font-weight:600;transition:background .2s;display:flex;align-items:center;gap:6px}
.profile-cover-edit:hover{background:rgba(79,142,247,.4)}
.profile-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:24px}
.profile-identity{padding:0 28px 24px;position:relative}
.profile-avatar-wrap{position:relative;display:inline-block;margin-top:-44px;margin-bottom:12px}
.profile-avatar-large{width:88px;height:88px;border-radius:50%;border:3px solid var(--surface);object-fit:cover;display:block;background:var(--surface2)}
.profile-avatar-edit-btn{position:absolute;bottom:2px;right:2px;width:26px;height:26px;border-radius:50%;background:var(--accent);border:2px solid var(--surface);color:white;font-size:.7rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s}
.profile-avatar-edit-btn:hover{background:#3a7ae0}
.profile-display-name{font-size:1.5rem;font-weight:800;letter-spacing:-.03em;line-height:1.1}
.profile-username{font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--accent);margin-top:4px}
.profile-bio{font-family:'Newsreader',serif;font-size:.9rem;color:rgba(232,234,240,.7);font-weight:300;line-height:1.6;margin-top:10px;max-width:520px}
.profile-badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.profile-badge{font-family:'JetBrains Mono',monospace;font-size:.6rem;padding:3px 10px;border-radius:99px;text-transform:uppercase;letter-spacing:.08em;border:1px solid}
.profile-stats-row{display:grid;grid-template-columns:repeat(4,1fr);border-top:1px solid var(--border);margin-top:20px}
.profile-stat{padding:16px;text-align:center;border-right:1px solid var(--border)}
.profile-stat:last-child{border-right:none}
.profile-stat-val{font-size:1.4rem;font-weight:800;letter-spacing:-.03em;line-height:1;margin-bottom:4px}
.profile-stat-label{font-family:'JetBrains Mono',monospace;font-size:.58rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted)}
.profile-section-title{font-size:.78rem;font-weight:700;letter-spacing:.04em;text-transform:uppercase;color:var(--muted);margin-bottom:14px;display:flex;align-items:center;gap:8px}
.profile-section-title::after{content:'';flex:1;height:1px;background:var(--border)}
.avatar-picker-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin:12px 0}
.avatar-option{width:100%;aspect-ratio:1;border-radius:50%;border:2px solid var(--border);cursor:pointer;object-fit:cover;transition:border-color .2s,transform .2s}
.avatar-option:hover,.avatar-option.selected{border-color:var(--accent);transform:scale(1.08)}

/* â”€â”€ HEX COVER PICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cover-preset-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px}
.cover-preset{height:48px;border-radius:8px;border:2px solid var(--border);cursor:pointer;transition:border-color .2s,transform .15s;position:relative;overflow:hidden}
.cover-preset::before{content:'';position:absolute;inset:0;background-image:radial-gradient(circle at 30% 50%,rgba(255,255,255,.2) 0%,transparent 60%)}
.cover-preset:hover,.cover-preset.selected{border-color:var(--accent);transform:scale(1.04)}
.cover-preset.selected::after{content:'âœ“';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;color:white;font-size:.9rem;background:rgba(79,142,247,.35)}
.hex-input-section{border-top:1px solid var(--border);padding-top:16px;margin-top:4px}
.hex-input-row{display:flex;gap:10px;align-items:center}
.hex-color-input{width:48px;height:48px;border:2px solid var(--border);border-radius:10px;cursor:pointer;padding:4px;background:var(--surface2);flex-shrink:0}
.hex-text-input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 14px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.85rem;outline:none;transition:border-color .2s}
.hex-text-input:focus{border-color:var(--accent)}
.hex-apply-btn{background:var(--accent);border:none;color:white;padding:10px 16px;border-radius:10px;cursor:pointer;font-size:.75rem;font-weight:700;font-family:'Syne',sans-serif;white-space:nowrap}
.cover-live-preview{height:80px;border-radius:10px;margin-top:12px;border:1px solid var(--border);position:relative;overflow:hidden;transition:background .4s ease}
.cover-live-preview::before{content:'';position:absolute;inset:0;background-image:radial-gradient(circle at 25% 50%,rgba(255,255,255,.18) 0%,transparent 55%),radial-gradient(circle at 78% 22%,rgba(255,255,255,.1) 0%,transparent 45%)}
.cover-live-preview-label{position:absolute;bottom:8px;left:12px;font-family:'JetBrains Mono',monospace;font-size:.58rem;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.1em}

/* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:768px){
  .stats-grid{grid-template-columns:1fr 1fr}
  .profile-stats-row{grid-template-columns:repeat(2,1fr)}
  .profile-stat:nth-child(2){border-right:none}
  .profile-stat:nth-child(3){border-top:1px solid var(--border)}
}
@media(max-width:600px){
  .hamburger{display:flex}
  .sidebar{transform:translateX(-100%)}
  .sidebar-close-btn{display:flex}
  .sidebar.open{transform:translateX(0)}
  .main{margin-left:0;padding:16px;padding-top:72px}
  .stats-grid{grid-template-columns:1fr 1fr}
  .page-title{font-size:1.5rem}
  .community-stats{grid-template-columns:repeat(3,1fr)}
  .cover-preset-grid{grid-template-columns:repeat(3,1fr)}
}
@media(max-width:400px){
  .stats-grid{grid-template-columns:1fr}
  .community-stats{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>

<div id="loading"><div class="loader-logo">LifeVault</div><div class="loader-bar"></div></div>

<!-- Mobile hamburger -->
<button class="hamburger" id="hamburger-btn" onclick="toggleSidebar()" aria-label="Menu">
  <span></span><span></span><span></span>
</button>
<div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">LifeVault</div>
    <div class="auth-tagline">Your personal space for thoughts, tasks &amp; goals</div>
    <div class="auth-features">
      <div class="auth-feature"><div class="auth-feature-icon" style="background:rgba(52,211,153,.15)">ğŸ““</div><span>Daily journal with mood tracking</span></div>
      <div class="auth-feature"><div class="auth-feature-icon" style="background:rgba(79,142,247,.15)">âœ…</div><span>Smart task manager with priorities</span></div>
      <div class="auth-feature"><div class="auth-feature-icon" style="background:rgba(167,139,250,.15)">ğŸ¯</div><span>Goal tracker with visual progress</span></div>
      <div class="auth-feature"><div class="auth-feature-icon" style="background:rgba(45,212,191,.15)">ğŸŒ</div><span>Community feed â€” share &amp; inspire</span></div>
    </div>
    <button class="google-btn" id="google-login-btn">
      <svg class="google-icon" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Continue with Google
    </button>
    <div class="privacy-note">ğŸ”’ Your data is private. Only what you share goes public.</div>
  </div>
</div>

<div id="app">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-logo">LifeVault</div>
    <button class="sidebar-close-btn" onclick="closeSidebar()" aria-label="Close menu">âœ•</button>
    <div class="nav-section-label">Overview</div>
    <div class="nav-item active" onclick="navigate('dashboard', event)"><span class="nav-icon">ğŸ </span> Dashboard</div>
    <div class="nav-section-label" style="margin-top:12px">Tools</div>
    <div class="nav-item" onclick="navigate('journal', event)"><span class="nav-icon">ğŸ““</span> Journal</div>
    <div class="nav-item" onclick="navigate('tasks', event)"><span class="nav-icon">âœ…</span> Tasks</div>
    <div class="nav-item" onclick="navigate('goals', event)"><span class="nav-icon">ğŸ¯</span> Goals</div>
    <div class="nav-item" onclick="navigate('insights', event)"><span class="nav-icon">ğŸ“Š</span> Insights</div>
    <div class="nav-section-label" style="margin-top:12px">Social</div>
    <div class="nav-item" onclick="navigate('community', event)" id="nav-community"><span class="nav-icon">ğŸŒ</span> Community <span id="new-posts-dot" style="display:none" class="notification-dot"></span></div>
    <div class="nav-item" onclick="navigate('profile', event)"><span class="nav-icon">ğŸ‘¤</span> Profile</div>
    <div class="sidebar-bottom">
      <div class="user-card" onclick="navigate('profile')" style="cursor:pointer" title="View profile">
        <img class="user-avatar" id="user-avatar" src="" alt="">
        <div class="user-info"><div class="user-name" id="user-name">â€”</div><div class="user-email" id="user-email">â€”</div></div>
        <button class="signout-btn" onclick="event.stopPropagation();signOut()" title="Sign Out">â‡¥</button>
      </div>
    </div>
  </aside>

  <main class="main">
    <!-- DASHBOARD -->
    <div id="page-dashboard" class="page active">
      <div class="page-header">
        <div>
          <div class="page-title">Good <span id="greeting-time">day</span> âœ¦</div>
          <div class="page-subtitle" id="today-date"></div>
          <div style="font-size:.9rem;color:var(--muted);font-family:'Newsreader',serif;font-style:italic;margin-top:6px" id="daily-motivation"></div>
        </div>
        <button class="btn btn-primary" onclick="openEntryTypeModal()">+ New Entry</button>
      </div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">Journal Entries</div><div class="stat-value" id="stat-entries" style="color:var(--accent)">0</div><div class="stat-change">All time</div></div>
        <div class="stat-card"><div class="stat-label">Tasks Done</div><div class="stat-value" id="stat-tasks" style="color:var(--green)">0</div><div class="stat-change">This week</div></div>
        <div class="stat-card"><div class="stat-label">Active Goals</div><div class="stat-value" id="stat-goals" style="color:var(--lavender)">0</div><div class="stat-change">In progress</div></div>
        <div class="stat-card"><div class="stat-label">Streak</div><div class="stat-value" id="stat-streak" style="color:var(--amber)">0</div><div class="stat-change">days ğŸ”¥</div></div>
        <div class="stat-card"><div class="stat-label">Fav Mood</div><div class="stat-value" id="stat-mood" style="font-size:2rem">â€”</div><div class="stat-change">Most common</div></div>
      </div>
      <div style="margin-bottom:16px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" onclick="exportAsJSON()">ğŸ’¾ Export Backup</button>
        <button class="btn" onclick="navigate('community')" style="border-color:rgba(45,212,191,.3);color:var(--teal)">ğŸŒ Community Feed</button>
      </div>
      <div class="grid-2">
        <div class="card">
          <div class="card-title">ğŸ““ Recent Entries <span style="font-family:'JetBrains Mono',monospace;font-size:.58rem;color:var(--muted);font-weight:400;margin-left:auto">â†— click to expand</span></div>
          <div id="dash-journal-list"></div>
        </div>
        <div class="card"><div class="card-title">âœ… Today's Tasks</div><div id="dash-task-list"></div></div>
      </div>
      <div class="card"><div class="card-title">ğŸ¯ Goals Progress <button class="btn-sm" style="margin-left:auto" onclick="navigate('goals')">View all</button></div><div id="dash-goals-list"></div></div>
    </div>

    <!-- JOURNAL -->
    <div id="page-journal" class="page">
      <div class="page-header">
        <div><div class="page-title">Journal</div><div class="page-subtitle">Capture your thoughts, feelings &amp; moments</div></div>
        <button class="btn btn-primary" onclick="openJournalModal()">+ New Entry</button>
      </div>
      <div style="margin-bottom:16px"><input type="text" id="journal-search" class="form-input" placeholder="ğŸ” Search by title, content or tags..." oninput="filterJournals()"></div>
      <div id="journal-list"></div>
    </div>

    <!-- TASKS -->
    <div id="page-tasks" class="page">
      <div class="page-header">
        <div><div class="page-title">Tasks</div><div class="page-subtitle">Stay focused, get things done</div></div>
        <button class="btn btn-primary" onclick="openTaskModal()">+ Add Task</button>
      </div>
      <div class="grid-2">
        <div class="card"><div class="card-title" style="color:var(--rose)">ğŸ”´ High Priority</div><div id="tasks-high"></div></div>
        <div class="card"><div class="card-title" style="color:var(--amber)">ğŸŸ¡ Medium Priority</div><div id="tasks-med"></div></div>
      </div>
      <div class="card"><div class="card-title" style="color:var(--green)">ğŸŸ¢ Low Priority &amp; Done</div><div id="tasks-low"></div></div>
    </div>

    <!-- GOALS -->
    <div id="page-goals" class="page">
      <div class="page-header">
        <div><div class="page-title">Goals</div><div class="page-subtitle">Dream big, track progress, celebrate wins</div></div>
        <button class="btn btn-primary" onclick="openGoalModal()">+ New Goal</button>
      </div>
      <div id="goals-list"></div>
    </div>

    <!-- INSIGHTS -->
    <div id="page-insights" class="page">
      <div class="page-header"><div><div class="page-title">Insights</div><div class="page-subtitle">Patterns in your mood &amp; productivity</div></div></div>
      <div class="streak-display"><div class="streak-number" id="insight-streak">0</div><div class="streak-label">ğŸ”¥ Day Journaling Streak</div></div>
      <div class="grid-2">
        <div class="card"><div class="card-title">ğŸ“ˆ Mood This Week</div><div id="mood-chart"></div></div>
        <div class="card"><div class="card-title">ğŸ“Š Activity Summary</div><div id="activity-summary"></div></div>
      </div>
      <div class="card" style="margin-top:20px"><div class="card-title">ğŸ“ˆ 7-Day Mood Trend</div><div id="mood-trend-chart" style="padding:12px;background:var(--surface2);border-radius:8px"></div></div>
    </div>

    <!-- COMMUNITY -->
    <div id="page-community" class="page">
      <div class="page-header">
        <div><div class="page-title">Community ğŸŒ</div><div class="page-subtitle">Share your journey Â· inspire others Â· grow together</div></div>
        <button class="btn" onclick="openShareModal()" style="border-color:rgba(45,212,191,.3);color:var(--teal)">â†— Share Something</button>
      </div>
      <div class="community-stats">
        <div class="comm-stat"><div class="comm-stat-val" id="comm-stat-posts" style="color:var(--accent)">â€”</div><div class="comm-stat-label">Total Posts</div></div>
        <div class="comm-stat"><div class="comm-stat-val" id="comm-stat-members" style="color:var(--teal)">â€”</div><div class="comm-stat-label">Members</div></div>
        <div class="comm-stat"><div class="comm-stat-val" id="comm-stat-likes" style="color:var(--rose)">â€”</div><div class="comm-stat-label">Likes Given</div></div>
      </div>
      <div class="feed-container">
        <div class="feed-composer">
          <div class="composer-top">
            <img class="composer-avatar" id="composer-avatar" src="" alt="">
            <textarea class="composer-input" id="composer-text" placeholder="Share a thought, update, or inspirationâ€¦" rows="3"></textarea>
          </div>
          <div class="composer-bottom">
            <div class="composer-actions">
              <button class="composer-type-btn active" data-type="thought" onclick="setComposerType('thought')">ğŸ’­ Thought</button>
              <button class="composer-type-btn" data-type="journal" onclick="openShareModal('journal')">ğŸ““ Journal</button>
              <button class="composer-type-btn" data-type="task" onclick="openShareModal('task')">âœ… Task</button>
              <button class="composer-type-btn" data-type="goal" onclick="openShareModal('goal')">ğŸ¯ Goal</button>
            </div>
            <button class="btn btn-primary" onclick="postThought()" style="padding:8px 18px">Post</button>
          </div>
        </div>
        <div class="feed-filters">
          <button class="feed-filter-btn active" onclick="filterFeed('all',this)">All</button>
          <button class="feed-filter-btn" onclick="filterFeed('thought',this)">ğŸ’­ Thoughts</button>
          <button class="feed-filter-btn" onclick="filterFeed('journal',this)">ğŸ““ Journals</button>
          <button class="feed-filter-btn" onclick="filterFeed('task',this)">âœ… Tasks</button>
          <button class="feed-filter-btn" onclick="filterFeed('goal',this)">ğŸ¯ Goals</button>
          <button class="feed-filter-btn" onclick="filterFeed('mine',this)">ğŸ‘¤ Mine</button>
        </div>
        <div id="feed-list"><div class="loading-posts">Loading community postsâ€¦</div></div>
      </div>
    </div>

    <!-- PROFILE -->
    <div id="page-profile" class="page">
      <div class="page-header">
        <div><div class="page-title">Profile</div><div class="page-subtitle">Your identity in LifeVault</div></div>
        <button class="btn btn-primary" onclick="openEditProfileModal()">âœ Edit Profile</button>
      </div>
      <div class="profile-card">
        <div class="profile-cover" id="profile-cover-display">
          <button class="profile-cover-edit" onclick="openCoverModal()">ğŸ–¼ Change Cover</button>
        </div>
        <div class="profile-identity">
          <div class="profile-avatar-wrap">
            <img id="profile-avatar-large" class="profile-avatar-large" src="" alt="">
            <button class="profile-avatar-edit-btn" onclick="openAvatarModal()">âœ</button>
          </div>
          <div style="display:flex;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;gap:12px">
            <div>
              <div class="profile-display-name" id="profile-display-name">â€”</div>
              <div class="profile-username" id="profile-username-display">@â€”</div>
            </div>
          </div>
          <div class="profile-bio" id="profile-bio-display">No bio yet.</div>
          <div id="profile-info-row" style="display:flex;flex-wrap:wrap;gap:4px;margin-top:10px;font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--muted)"></div>
          <div class="profile-badges" id="profile-badges"></div>
          <div class="profile-stats-row">
            <div class="profile-stat"><div class="profile-stat-val" id="pstat-journals" style="color:var(--accent)">0</div><div class="profile-stat-label">Journals</div></div>
            <div class="profile-stat"><div class="profile-stat-val" id="pstat-tasks" style="color:var(--green)">0</div><div class="profile-stat-label">Tasks</div></div>
            <div class="profile-stat"><div class="profile-stat-val" id="pstat-goals" style="color:var(--lavender)">0</div><div class="profile-stat-label">Goals</div></div>
            <div class="profile-stat"><div class="profile-stat-val" id="pstat-posts" style="color:var(--teal)">0</div><div class="profile-stat-label">Posts</div></div>
          </div>
        </div>
      </div>
      <div class="card" style="margin-bottom:24px">
        <div class="profile-section-title">ğŸŒ My Community Posts</div>
        <div id="profile-my-posts"><div class="loading-posts" style="padding:24px;text-align:center;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:.72rem">Loading your postsâ€¦</div></div>
      </div>
    </div>
  </main>
</div>

<!-- JOURNAL EXPAND OVERLAY -->
<div class="journal-expand-overlay" id="journal-expand-overlay">
  <div class="journal-expanded-card">
    <div class="expanded-card-header">
      <div style="flex:1;min-width:0">
        <div class="expanded-card-title" id="exp-title"></div>
        <div class="expanded-card-meta">
          <span class="expanded-mood-badge" id="exp-mood"></span>
          <span class="expanded-card-date" id="exp-date"></span>
        </div>
      </div>
      <button class="expanded-close-btn" onclick="closeExpandedJournal()">âœ•</button>
    </div>
    <div class="expanded-card-body">
      <div class="expanded-card-content" id="exp-content"></div>
      <div class="expanded-photos" id="exp-photos" style="display:none"></div>
      <div class="expanded-tags" id="exp-tags" style="display:none"></div>
    </div>
    <div class="expanded-card-footer">
      <button class="btn" onclick="shareJournalFromExpanded()">â†— Share</button>
      <button class="btn" onclick="editFromExpanded()">âœ Edit</button>
      <button class="btn btn-primary" onclick="closeExpandedJournal()">Done</button>
    </div>
  </div>
</div>

<!-- SHARE MODAL -->
<div class="modal-backdrop" id="share-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="share-modal-title">â†— Share to Community</div>
      <button class="modal-close" onclick="closeModal('share-modal')">âœ•</button>
    </div>
    <div id="share-modal-body"></div>
  </div>
</div>

<!-- ENTRY TYPE MODAL -->
<div class="modal-backdrop" id="entry-type-modal">
  <div class="modal" style="max-width:400px">
    <div class="modal-header"><div class="modal-title">What would you like to create?</div><button class="modal-close" onclick="closeModal('entry-type-modal')">âœ•</button></div>
    <div style="display:flex;flex-direction:column;gap:12px;margin-top:12px">
      <button class="btn btn-primary" style="padding:16px;font-size:1rem;justify-content:center" onclick="closeModal('entry-type-modal');openJournalModal()">ğŸ““ Journal Entry</button>
      <button class="btn btn-primary" style="padding:16px;font-size:1rem;justify-content:center" onclick="closeModal('entry-type-modal');openTaskModal()">âœ… Task</button>
      <button class="btn btn-primary" style="padding:16px;font-size:1rem;justify-content:center" onclick="closeModal('entry-type-modal');openGoalModal()">ğŸ¯ Goal</button>
    </div>
  </div>
</div>

<!-- JOURNAL MODAL -->
<div class="modal-backdrop" id="journal-modal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="jmodal-title">ğŸ““ New Journal Entry</div><button class="modal-close" onclick="closeModal('journal-modal')">âœ•</button></div>
    <div class="form-group"><label class="form-label">Title (optional)</label><input type="text" class="form-input" id="journal-title" placeholder="Give this moment a title..."></div>
    <div class="form-group">
      <label class="form-label">How are you feeling?</label>
      <div class="mood-picker" id="mood-picker">
        <div class="mood-option" data-mood="5" onclick="selectMood(5,'ğŸ˜„')">ğŸ˜„<span>Great</span></div>
        <div class="mood-option" data-mood="4" onclick="selectMood(4,'ğŸ™‚')">ğŸ™‚<span>Good</span></div>
        <div class="mood-option" data-mood="3" onclick="selectMood(3,'ğŸ˜')">ğŸ˜<span>Okay</span></div>
        <div class="mood-option" data-mood="2" onclick="selectMood(2,'ğŸ˜”')">ğŸ˜”<span>Low</span></div>
        <div class="mood-option" data-mood="1" onclick="selectMood(1,'ğŸ˜¢')">ğŸ˜¢<span>Rough</span></div>
      </div>
    </div>
    <div class="form-group"><label class="form-label">Your thoughts</label><textarea class="form-textarea" id="journal-content" style="min-height:160px" placeholder="What's on your mind?"></textarea></div>
    <div class="form-group"><label class="form-label">Tags (comma-separated)</label><input type="text" class="form-input" id="journal-tags" placeholder="gratitude, work, family..."></div>
    <div class="form-group">
      <label class="form-label">Photos (optional â€” max 6)</label>
      <input type="file" id="journal-photos" multiple accept="image/*" style="display:block;color:var(--muted);font-size:.8rem">
      <div id="photo-preview" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px"></div>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
      <button class="btn" onclick="closeModal('journal-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveJournalEntry()">Save Entry</button>
    </div>
  </div>
</div>

<!-- TASK MODAL -->
<div class="modal-backdrop" id="task-modal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="tmodal-title">âœ… Add Task</div><button class="modal-close" onclick="closeModal('task-modal')">âœ•</button></div>
    <div class="form-group"><label class="form-label">Task</label><input type="text" class="form-input" id="task-text" placeholder="What needs to be done?"></div>
    <div class="form-group"><label class="form-label">Priority</label><select class="form-select" id="task-priority"><option value="high">ğŸ”´ High</option><option value="med" selected>ğŸŸ¡ Medium</option><option value="low">ğŸŸ¢ Low</option></select></div>
    <div class="form-group"><label class="form-label">Note (optional)</label><input type="text" class="form-input" id="task-note" placeholder="Any details..."></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
      <button class="btn" onclick="closeModal('task-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveTask()">Save Task</button>
    </div>
  </div>
</div>

<!-- GOAL MODAL -->
<div class="modal-backdrop" id="goal-modal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="gmodal-title">ğŸ¯ New Goal</div><button class="modal-close" onclick="closeModal('goal-modal')">âœ•</button></div>
    <div class="form-group"><label class="form-label">Goal Name</label><input type="text" class="form-input" id="goal-name" placeholder="What do you want to achieve?"></div>
    <div class="form-group"><label class="form-label">Category</label><select class="form-select" id="goal-category"><option value="health">ğŸ’ª Health &amp; Fitness</option><option value="learn">ğŸ“š Learning</option><option value="finance">ğŸ’° Finance</option><option value="career">ğŸ’¼ Career</option><option value="personal" selected>ğŸŒ± Personal Growth</option><option value="other">â­ Other</option></select></div>
    <div class="form-group"><label class="form-label">Target</label><input type="text" class="form-input" id="goal-target" placeholder="e.g. Read 12 books, Run 5km..."></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
      <button class="btn" onclick="closeModal('goal-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveGoal()">Create Goal</button>
    </div>
  </div>
</div>

<!-- EDIT PROFILE MODAL -->
<div class="modal-backdrop" id="edit-profile-modal">
  <div class="modal" style="max-width:560px">
    <div class="modal-header"><div class="modal-title">âœ Edit Profile</div><button class="modal-close" onclick="closeModal('edit-profile-modal')">âœ•</button></div>
    <div class="form-group"><label class="form-label">Full Name</label><input type="text" class="form-input" id="edit-fullname" placeholder="Your full name..."></div>
    <div class="form-group">
      <label class="form-label">Username</label>
      <div style="position:relative"><span style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:.85rem">@</span><input type="text" class="form-input" id="edit-username" placeholder="yourhandle" style="padding-left:28px"></div>
      <div style="font-size:.68rem;color:var(--muted);margin-top:5px;font-family:'JetBrains Mono',monospace">Lowercase letters, numbers, underscores only</div>
    </div>
    <div class="form-group"><label class="form-label">Bio</label><textarea class="form-textarea" id="edit-bio" placeholder="Tell the community a bit about yourselfâ€¦" style="min-height:90px"></textarea></div>
    <div class="form-group"><label class="form-label">Location <span style="opacity:.5">(optional)</span></label><input type="text" class="form-input" id="edit-location" placeholder="City, Country..."></div>
    <div class="form-group"><label class="form-label">Website <span style="opacity:.5">(optional)</span></label><input type="text" class="form-input" id="edit-website" placeholder="https://..."></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
      <button class="btn" onclick="closeModal('edit-profile-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveProfile()">Save Profile</button>
    </div>
  </div>
</div>

<!-- AVATAR MODAL -->
<div class="modal-backdrop" id="avatar-modal">
  <div class="modal" style="max-width:480px">
    <div class="modal-header"><div class="modal-title">ğŸ–¼ Change Avatar</div><button class="modal-close" onclick="closeModal('avatar-modal')">âœ•</button></div>
    <div class="form-group">
      <label class="form-label">Upload your own</label>
      <input type="file" id="avatar-upload" accept="image/*" style="color:var(--muted);font-size:.8rem;display:block">
      <div style="font-size:.68rem;color:var(--muted);margin-top:4px;font-family:'JetBrains Mono',monospace">Auto-compressed to ~80KB</div>
    </div>
    <div class="form-group"><label class="form-label">Or pick a preset</label><div class="avatar-picker-grid" id="avatar-preset-grid"></div></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
      <button class="btn" onclick="closeModal('avatar-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveAvatar()">Apply Avatar</button>
    </div>
  </div>
</div>

<!-- COVER MODAL â€” with hex picker -->
<div class="modal-backdrop" id="cover-modal">
  <div class="modal" style="max-width:520px">
    <div class="modal-header"><div class="modal-title">ğŸ–¼ Change Cover</div><button class="modal-close" onclick="closeModal('cover-modal')">âœ•</button></div>

    <div class="form-group">
      <label class="form-label">Preset Gradients</label>
      <div class="cover-preset-grid" id="cover-preset-grid"></div>
    </div>

    <div class="hex-input-section">
      <label class="form-label" style="display:block;margin-bottom:10px">ğŸ¨ Custom Color â€” enter a hex code to auto-generate a gradient</label>
      <div class="hex-input-row">
        <input type="color" class="hex-color-input" id="hex-color-wheel" title="Pick a color">
        <input type="text" class="hex-text-input" id="hex-text-input" placeholder="#4f8ef7" maxlength="7">
        <button class="hex-apply-btn" onclick="applyHexCover()">Apply âœ“</button>
      </div>
      <div class="cover-live-preview" id="cover-live-preview">
        <span class="cover-live-preview-label">Live Preview</span>
      </div>
      <div style="font-size:.65rem;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-top:8px;opacity:.7">The gradient is auto-generated: your color is blended with dark tones to keep the cover elegant.</div>
    </div>

    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
      <button class="btn" onclick="closeModal('cover-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveCover()">Apply Cover</button>
    </div>
  </div>
</div>

<div class="toast-container" id="toast-container"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut as fbSignOut }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, getDoc, doc, setDoc, updateDoc, deleteDoc,
         query, orderBy, limit, where, arrayUnion, arrayRemove, increment, serverTimestamp, onSnapshot, Timestamp }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCXl_R3gnGX_rxfjy6rNi_JdJNgdbNVTg0",
  authDomain: "resume-analyzer-2d4f2.firebaseapp.com",
  projectId: "resume-analyzer-2d4f2",
  storageBucket: "resume-analyzer-2d4f2.firebasestorage.app",
  messagingSenderId: "1029896274597",
  appId: "1:1029896274597:web:b73c1d51c445364f67434c",
  measurementId: "G-XZKS65TXKG"
};
const fbApp = initializeApp(firebaseConfig);
const auth  = getAuth(fbApp);
const db    = getFirestore(fbApp);

let currentUser = null;
let journals = [], tasks = [], goals = [];
let editJournalId = null, editTaskId = null, editGoalId = null;
let photoUrls = [];
let moodVal = 3, moodEmoji = 'ğŸ˜';
let draggedId = null;
let expandedJournalId = null;
let currentFeedFilter = 'all';
let feedPosts = [];
let feedUnsubscribe = null;
let composerType = 'thought';
let userProfile = {};
let selectedAvatarUrl = '';
let selectedCoverData = null; // { type: 'preset'|'hex', value: string (gradient CSS) }

const MOTIVATIONS = ["Every small step counts ğŸš€","Progress, not perfection ğŸ¯","You're stronger than you think ğŸ’ª","Today is full of possibilities âœ¨","Be kind to yourself ğŸ’–","Your future self will thank you ğŸ™","You've got this! ğŸ”¥","Growth happens outside comfort zones ğŸŒ±"];
const CAT_ICONS = {health:'ğŸ’ª',learn:'ğŸ“š',finance:'ğŸ’°',career:'ğŸ’¼',personal:'ğŸŒ±',other:'â­'};
const COLORS    = ['var(--accent)','var(--lavender)','var(--teal)','var(--green)','var(--amber)','var(--rose)'];
const M_EMOJI   = {1:'ğŸ˜¢',2:'ğŸ˜”',3:'ğŸ˜',4:'ğŸ™‚',5:'ğŸ˜„'};
const TYPE_BADGES = {thought:'ğŸ’­ Thought',journal:'ğŸ““ Journal',task:'âœ… Task',goal:'ğŸ¯ Goal'};
const TYPE_BADGE_CLASS = {thought:'badge-journal',journal:'badge-journal',task:'badge-task',goal:'badge-goal'};

const COVER_PRESETS = [
  'linear-gradient(135deg,#0d1b2a,#1b3a5c,#0d1b2a)',
  'linear-gradient(135deg,#0f0c29,#302b63,#24243e)',
  'linear-gradient(135deg,#093028,#237a57,#093028)',
  'linear-gradient(135deg,#1a0533,#3d1a7a,#11998e)',
  'linear-gradient(135deg,#200122,#6f0000,#200122)',
  'linear-gradient(135deg,#141e30,#243b55,#141e30)',
  'linear-gradient(135deg,#1f1c2c,#4a4580,#1f1c2c)',
  'linear-gradient(135deg,#0b0f1a,#1e3a5f,#0b0f1a)',
];

const AVATAR_PRESETS = [
  'https://api.dicebear.com/7.x/bottts/svg?seed=lv1&backgroundColor=4f8ef7',
  'https://api.dicebear.com/7.x/bottts/svg?seed=lv2&backgroundColor=a78bfa',
  'https://api.dicebear.com/7.x/bottts/svg?seed=lv3&backgroundColor=34d399',
  'https://api.dicebear.com/7.x/bottts/svg?seed=lv4&backgroundColor=f87171',
  'https://api.dicebear.com/7.x/bottts/svg?seed=lv5&backgroundColor=fbbf24',
  'https://api.dicebear.com/7.x/personas/svg?seed=lv1',
  'https://api.dicebear.com/7.x/personas/svg?seed=lv2',
  'https://api.dicebear.com/7.x/personas/svg?seed=lv3',
  'https://api.dicebear.com/7.x/personas/svg?seed=lv4',
  'https://api.dicebear.com/7.x/personas/svg?seed=lv5',
];

/* â•â• MOBILE SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.toggleSidebar = () => {
  const s = document.getElementById('sidebar');
  const o = document.getElementById('sidebar-overlay');
  const h = document.getElementById('hamburger-btn');
  const isOpen = s.classList.contains('open');
  s.classList.toggle('open', !isOpen);
  o.classList.toggle('open', !isOpen);
  h.classList.toggle('open', !isOpen);
};
window.closeSidebar = () => {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').classList.remove('open');
  document.getElementById('hamburger-btn').classList.remove('open');
};

/* â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.addEventListener('load', () => {
  setTimeout(() => {
    document.getElementById('loading').classList.add('hidden');
    onAuthStateChanged(auth, user => {
      if (user) { currentUser = user; showApp(user); loadAll(); }
      else showAuth();
    });
    // Fallback if auth never fires
    setTimeout(() => {
      const auth = document.getElementById('auth-screen');
      const app  = document.getElementById('app');
      if (auth.style.display === 'none' && app.style.display === 'none') showAuth();
    }, 6000);
  }, 1200);
});

function showAuth() {
  document.getElementById('auth-screen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
}
function showApp(user) {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.getElementById('user-name').textContent = user.displayName || 'User';
  document.getElementById('user-email').textContent = user.email;
  const av = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName||'U')}&background=4f8ef7&color=fff`;
  document.getElementById('user-avatar').src = av;
  document.getElementById('composer-avatar').src = av;
  updateGreeting();
  loadUserProfile();
}

/* â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.getElementById('google-login-btn').onclick = async () => {
  try { await signInWithPopup(auth, new GoogleAuthProvider()); }
  catch(e) { toast(e.message || 'Login failed', 'âŒ'); }
};
window.signOut = async () => {
  if (!confirm('Sign out?')) return;
  if (feedUnsubscribe) feedUnsubscribe();
  await fbSignOut(auth);
};

/* â•â• LOAD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadAll() {
  if (!currentUser) return;
  const uid = currentUser.uid;
  try {
    const [j,t,g] = await Promise.all([
      getDocs(query(collection(db,'users',uid,'journals'), orderBy('createdAt','desc'))),
      getDocs(query(collection(db,'users',uid,'tasks'),   orderBy('createdAt','desc'))),
      getDocs(query(collection(db,'users',uid,'goals'),   orderBy('createdAt','desc')))
    ]);
    journals = j.docs.map(d => ({id:d.id,...d.data(), createdAt:d.data().createdAt?.toDate()}));
    tasks    = t.docs.map(d => ({id:d.id,...d.data(), createdAt:d.data().createdAt?.toDate()}));
    goals    = g.docs.map(d => ({id:d.id,...d.data(), createdAt:d.data().createdAt?.toDate()}));
    renderAll();
  } catch(e) { toast('Load error: '+e.message,'âŒ'); }
}

function updateGreeting() {
  const h = new Date().getHours();
  document.getElementById('greeting-time').textContent = h<12?'morning':h<17?'afternoon':'evening';
  document.getElementById('today-date').textContent = new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  document.getElementById('daily-motivation').textContent = MOTIVATIONS[Math.floor(Math.random()*MOTIVATIONS.length)];
}

/* â•â• NAVIGATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.navigate = (page, event) => {
  if (event) event.stopPropagation();
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.querySelector(`.nav-item[onclick="navigate('${page}')"]`).classList.add('active');
  closeSidebar();
  if (page === 'insights')   renderInsights();
  if (page === 'community')  { subscribeFeed(); document.getElementById('new-posts-dot').style.display='none'; }
  if (page === 'profile')    renderProfilePage();
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   JOURNAL EXPAND  â€”  FIX: use dataset + delegated listeners
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.openExpandedJournal = id => {
  const e = journals.find(j => j.id === id);
  if (!e) return;
  expandedJournalId = id;
  document.getElementById('exp-title').textContent   = e.title || 'Untitled';
  document.getElementById('exp-mood').textContent    = e.moodEmoji || 'ğŸ˜';
  document.getElementById('exp-date').textContent    = fmtDate(e.createdAt);
  document.getElementById('exp-content').textContent = e.content || '';

  const photosEl = document.getElementById('exp-photos');
  if (e.photoUrls?.length) {
    photosEl.style.display = 'flex';
    photosEl.innerHTML = e.photoUrls.map(u =>
      `<img src="${u}" class="expanded-photo" onclick="viewPhoto('${u}')">`
    ).join('');
  } else { photosEl.style.display = 'none'; photosEl.innerHTML = ''; }

  const tagsEl = document.getElementById('exp-tags');
  if (e.tags?.length) {
    tagsEl.style.display = 'flex';
    tagsEl.innerHTML = e.tags.map(t =>
      `<span class="tag" style="background:rgba(79,142,247,.12);color:var(--accent)">${esc(t)}</span>`
    ).join('');
  } else { tagsEl.style.display = 'none'; tagsEl.innerHTML = ''; }

  document.getElementById('journal-expand-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
};

window.closeExpandedJournal = () => {
  document.getElementById('journal-expand-overlay').classList.remove('open');
  document.body.style.overflow = '';
  expandedJournalId = null;
};

window.editFromExpanded = () => {
  const id = expandedJournalId;
  closeExpandedJournal();
  openJournalModal(id);
};

window.shareJournalFromExpanded = () => {
  if (expandedJournalId) { closeExpandedJournal(); setTimeout(() => shareJournal(expandedJournalId), 100); }
};

document.getElementById('journal-expand-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('journal-expand-overlay')) closeExpandedJournal();
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && expandedJournalId) closeExpandedJournal();
});

/* â•â• RENDER JOURNALS â€” template literals, data-id delegation â•â• */
function renderJournals(containerId, maxCount, isDash) {
  const container = document.getElementById(containerId);
  if (!container) return;
  const list = maxCount ? journals.slice(0, maxCount) : journals;

  if (!list.length) {
    container.innerHTML = `<div class="empty-state">
      <div class="empty-icon">ğŸ“–</div>
      <div class="empty-text">No entries yet.</div>
      <button class="btn btn-primary" onclick="openJournalModal()">Write first entry</button>
    </div>`;
    return;
  }

  container.innerHTML = list.map(e => {
    const photosHtml = e.photoUrls?.length
      ? `<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:10px">
          ${e.photoUrls.map(u => `<img src="${u}" style="width:64px;height:64px;border-radius:8px;object-fit:cover;border:1px solid var(--border)" data-photo="${u}">`).join('')}
        </div>` : '';
    const tagsHtml = e.tags?.length
      ? `<div class="entry-tags">${e.tags.map(t => `<span class="tag" style="background:rgba(79,142,247,.12);color:var(--accent)">${esc(t)}</span>`).join('')}</div>`
      : '';

    const actionBtns = isDash
      ? `<button class="journal-entry-actions" data-share="${e.id}" title="Share" style="background:none;border:1px solid rgba(45,212,191,.3);color:var(--teal);cursor:pointer;font-size:.72rem;padding:4px 8px;border-radius:6px">â†—</button>`
      : `<div class="journal-entry-actions">
           <button data-share="${e.id}" title="Share">â†—</button>
           <button data-edit="${e.id}" title="Edit">âœ</button>
           <button class="del-btn" data-del="${e.id}" title="Delete">âœ•</button>
         </div>`;

    return `<div class="journal-entry" data-expand="${e.id}">
      <div class="entry-header">
        <div>
          <div style="font-size:.85rem;font-weight:600;margin-bottom:2px">${esc(e.title || 'Untitled')}</div>
          <div class="entry-date">${fmtDate(e.createdAt)}</div>
        </div>
        <div style="display:flex;align-items:center;gap:6px">
          <span class="mood-emoji">${e.moodEmoji || 'ğŸ˜'}</span>
          ${actionBtns}
        </div>
      </div>
      <div class="entry-preview">${esc(e.content || '')}</div>
      ${photosHtml}${tagsHtml}
      <div class="entry-expand-hint">â†— tap to expand</div>
    </div>`;
  }).join('');

  // â”€â”€ Delegated click handler â€” ONE listener on the container â”€â”€
  container.onclick = e => {
    // Photo clicks
    const photoEl = e.target.closest('[data-photo]');
    if (photoEl) { e.stopPropagation(); viewPhoto(photoEl.dataset.photo); return; }

    // Action button clicks â€” stop propagation so they don't trigger expand
    const shareBtn = e.target.closest('[data-share]');
    if (shareBtn) { e.stopPropagation(); shareJournal(shareBtn.dataset.share); return; }

    const editBtn = e.target.closest('[data-edit]');
    if (editBtn) { e.stopPropagation(); openJournalModal(editBtn.dataset.edit); return; }

    const delBtn = e.target.closest('[data-del]');
    if (delBtn) { e.stopPropagation(); delJournal(delBtn.dataset.del); return; }

    // Expand â€” clicking anywhere on the card that isn't a button
    const entryEl = e.target.closest('[data-expand]');
    if (entryEl) { openExpandedJournal(entryEl.dataset.expand); }
  };
}

window.selectMood = (val, emoji) => {
  moodVal = val; moodEmoji = emoji;
  document.querySelectorAll('.mood-option').forEach(o => o.classList.remove('selected'));
  document.querySelector(`.mood-option[data-mood="${val}"]`).classList.add('selected');
};

window.openJournalModal = (id = null) => {
  editJournalId = id; photoUrls = [];
  document.getElementById('photo-preview').innerHTML = '';
  document.getElementById('journal-photos').value = '';
  document.getElementById('jmodal-title').textContent = id ? 'âœï¸ Edit Entry' : 'ğŸ““ New Journal Entry';
  if (id) {
    const e = journals.find(j => j.id === id);
    if (e) {
      document.getElementById('journal-title').value   = e.title || '';
      document.getElementById('journal-content').value = e.content || '';
      document.getElementById('journal-tags').value    = (e.tags || []).join(', ');
      moodVal = e.mood || 3; moodEmoji = e.moodEmoji || 'ğŸ˜';
      if (e.photoUrls?.length) { photoUrls = [...e.photoUrls]; renderPreviews(); }
      document.querySelectorAll('.mood-option').forEach(o => o.classList.remove('selected'));
      document.querySelector(`.mood-option[data-mood="${moodVal}"]`)?.classList.add('selected');
    }
  } else {
    document.getElementById('journal-title').value = '';
    document.getElementById('journal-content').value = '';
    document.getElementById('journal-tags').value = '';
    moodVal = 3; moodEmoji = 'ğŸ˜';
    document.querySelectorAll('.mood-option').forEach(o => o.classList.remove('selected'));
  }
  document.getElementById('journal-modal').classList.add('open');
  setTimeout(() => document.getElementById('journal-content').focus(), 100);
};

document.getElementById('journal-photos').addEventListener('change', async e => {
  const files = Array.from(e.target.files);
  if (!files.length) return;
  if (photoUrls.length + files.length > 6) { toast('Max 6 photos','âš ï¸'); return; }
  toast(`Compressing ${files.length} photo(s)â€¦`,'ğŸ“·');
  for (const f of files) {
    try { photoUrls.push(await compressImage(f)); } catch { toast('Could not read '+f.name,'âŒ'); }
  }
  renderPreviews(); e.target.value = ''; toast('Photos ready!','ğŸ“·');
});

function compressImage(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = reject;
    reader.onload = ev => {
      const img = new Image();
      img.onerror = reject;
      img.onload = () => {
        const T = 200*1024; const c = document.createElement('canvas'); const ctx = c.getContext('2d');
        let m = 800, q = 0.8, r = '';
        for (let i = 0; i < 8; i++) {
          let w = img.width, h = img.height;
          if (w > h) { if (w > m) { h = Math.round(h*m/w); w = m; } }
          else { if (h > m) { w = Math.round(w*m/h); h = m; } }
          c.width = w; c.height = h; ctx.clearRect(0,0,w,h); ctx.drawImage(img,0,0,w,h);
          r = c.toDataURL('image/jpeg', q);
          if (r.length*.75 <= T) break;
          if (q > .3) q -= .15; else { m = Math.round(m*.7); q = .6; }
        }
        resolve(r);
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function renderPreviews() {
  document.getElementById('photo-preview').innerHTML = photoUrls.map((u,i) =>
    `<div style="position:relative;width:60px;height:60px;border-radius:8px;overflow:hidden;border:1px solid var(--border)">
      <img src="${u}" style="width:100%;height:100%;object-fit:cover">
      <button style="position:absolute;top:0;right:0;background:rgba(0,0,0,.7);color:white;border:none;cursor:pointer;width:20px;height:20px;font-size:.7rem" onclick="rmPhoto(${i})">Ã—</button>
    </div>`
  ).join('');
}
window.rmPhoto = i => { photoUrls.splice(i,1); renderPreviews(); };

window.saveJournalEntry = async () => {
  const content = document.getElementById('journal-content').value.trim();
  if (!content) { toast('Write something first!','âœï¸'); return; }
  const data = {
    title: document.getElementById('journal-title').value.trim() || 'Untitled',
    content, mood: moodVal, moodEmoji,
    tags: document.getElementById('journal-tags').value.split(',').map(t=>t.trim()).filter(Boolean),
    photoUrls
  };
  try {
    if (editJournalId) {
      await updateDoc(doc(db,'users',currentUser.uid,'journals',editJournalId), data);
      const i = journals.findIndex(j => j.id === editJournalId);
      if (i !== -1) journals[i] = {...journals[i],...data};
      toast('Entry updated!','ğŸ““');
    } else {
      data.createdAt = Timestamp.now();
      const r = await addDoc(collection(db,'users',currentUser.uid,'journals'), data);
      journals.unshift({id:r.id,...data, createdAt:new Date()});
      toast('Entry saved! âœ¨','ğŸ““');
    }
    closeModal('journal-modal'); renderAll(); editJournalId = null;
  } catch(e) { toast('Error: '+e.message,'âŒ'); }
};

window.delJournal = async id => {
  if (!confirm('Delete this entry?')) return;
  journals = journals.filter(j => j.id !== id);
  await deleteDoc(doc(db,'users',currentUser.uid,'journals',id));
  renderAll(); toast('Entry deleted','ğŸ—‘ï¸');
};

window.viewPhoto = url => {
  const d = document.createElement('div');
  d.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.93);display:flex;align-items:center;justify-content:center;z-index:9999';
  d.innerHTML = `<img src="${url}" style="max-width:92%;max-height:92%;border-radius:10px">
    <button style="position:absolute;top:20px;right:24px;background:none;border:none;color:white;font-size:2.2rem;cursor:pointer" onclick="this.parentElement.remove()">Ã—</button>`;
  d.onclick = e => { if (e.target === d) d.remove(); };
  document.body.appendChild(d);
};

/* â•â• TASKS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.openTaskModal = (id = null) => {
  editTaskId = id;
  document.getElementById('tmodal-title').textContent = id ? 'âœï¸ Edit Task' : 'âœ… Add Task';
  if (id) {
    const t = tasks.find(t => t.id === id);
    if (t) {
      document.getElementById('task-text').value     = t.text;
      document.getElementById('task-note').value     = t.note || '';
      document.getElementById('task-priority').value = t.priority || 'med';
    }
  } else {
    document.getElementById('task-text').value = '';
    document.getElementById('task-note').value = '';
    document.getElementById('task-priority').value = 'med';
  }
  document.getElementById('task-modal').classList.add('open');
  setTimeout(() => document.getElementById('task-text').focus(), 100);
};

window.saveTask = async () => {
  const text = document.getElementById('task-text').value.trim();
  if (!text) { toast('Enter a task!','âœï¸'); return; }
  const data = { text, priority: document.getElementById('task-priority').value, note: document.getElementById('task-note').value.trim(), done: false };
  try {
    if (editTaskId) {
      await updateDoc(doc(db,'users',currentUser.uid,'tasks',editTaskId), data);
      const i = tasks.findIndex(t => t.id === editTaskId);
      if (i !== -1) tasks[i] = {...tasks[i],...data};
      toast('Task updated!','âœ…');
    } else {
      data.createdAt = Timestamp.now();
      const r = await addDoc(collection(db,'users',currentUser.uid,'tasks'), data);
      tasks.unshift({id:r.id,...data, createdAt:new Date()});
      toast('Task added!','âœ…');
    }
    closeModal('task-modal'); renderAll(); editTaskId = null;
  } catch(e) { toast('Error: '+e.message,'âŒ'); }
};

window.toggleTask = async id => {
  const t = tasks.find(t => t.id === id); if (!t) return;
  t.done = !t.done;
  await updateDoc(doc(db,'users',currentUser.uid,'tasks',id), {done:t.done});
  if (t.done) toast('Task done! ğŸ‰','âœ…');
  renderAll();
};

window.delTask = async id => {
  if (!confirm('Delete this task?')) return;
  tasks = tasks.filter(t => t.id !== id);
  await deleteDoc(doc(db,'users',currentUser.uid,'tasks',id));
  renderAll(); toast('Task removed','ğŸ—‘ï¸');
};

function renderTasksIn(container, list) {
  if (!list.length) {
    container.innerHTML = `<div style="padding:14px;color:var(--muted);font-size:.8rem;text-align:center;font-style:italic">All clear here âœ“</div>`;
    return;
  }
  container.innerHTML = list.map(t => `
    <div class="task-item ${t.done?'done':''}" draggable="true" ondragstart="dragStart(event,'${t.id}')" ondragover="dragOver(event)" ondrop="dropTask(event,'${t.priority}')">
      <div class="task-check ${t.done?'checked':''}" onclick="toggleTask('${t.id}')"></div>
      <div class="priority-dot p-${t.priority}"></div>
      <div class="task-text">${esc(t.text)}${t.note ? `<div style="font-size:.72rem;color:var(--muted);margin-top:2px">${esc(t.note)}</div>` : ''}</div>
      <button class="task-edit" onclick="openTaskModal('${t.id}')">âœ</button>
      <button class="task-del" onclick="delTask('${t.id}')">âœ•</button>
    </div>`).join('');
}

window.dragStart = (e, id) => { draggedId = id; e.dataTransfer.effectAllowed = 'move'; };
window.dragOver  = e => e.preventDefault();
window.dropTask  = (e, priority) => {
  e.preventDefault();
  const t = tasks.find(t => t.id === draggedId);
  if (t) { t.priority = priority; updateDoc(doc(db,'users',currentUser.uid,'tasks',draggedId),{priority}); renderAll(); }
  draggedId = null;
};

/* â•â• GOALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.openGoalModal = (id = null) => {
  editGoalId = id;
  document.getElementById('gmodal-title').textContent = id ? 'âœï¸ Edit Goal' : 'ğŸ¯ New Goal';
  if (id) {
    const g = goals.find(g => g.id === id);
    if (g) {
      document.getElementById('goal-name').value     = g.name;
      document.getElementById('goal-target').value   = g.target || '';
      document.getElementById('goal-category').value = g.category || 'personal';
    }
  } else {
    document.getElementById('goal-name').value = '';
    document.getElementById('goal-target').value = '';
    document.getElementById('goal-category').value = 'personal';
  }
  document.getElementById('goal-modal').classList.add('open');
  setTimeout(() => document.getElementById('goal-name').focus(), 100);
};

window.saveGoal = async () => {
  const name = document.getElementById('goal-name').value.trim();
  if (!name) { toast('Name your goal!','ğŸ¯'); return; }
  const data = { name, category: document.getElementById('goal-category').value, target: document.getElementById('goal-target').value.trim() };
  try {
    if (editGoalId) {
      await updateDoc(doc(db,'users',currentUser.uid,'goals',editGoalId), data);
      const i = goals.findIndex(g => g.id === editGoalId);
      if (i !== -1) goals[i] = {...goals[i],...data};
      toast('Goal updated!','ğŸ¯');
    } else {
      data.progress = 0; data.createdAt = Timestamp.now();
      const r = await addDoc(collection(db,'users',currentUser.uid,'goals'), data);
      goals.unshift({id:r.id,...data, createdAt:new Date()});
      toast('Goal created! ğŸš€','ğŸ¯');
    }
    closeModal('goal-modal'); renderAll(); editGoalId = null;
  } catch(e) { toast('Error: '+e.message,'âŒ'); }
};

window.updGoal = async (id, delta) => {
  const g = goals.find(g => g.id === id); if (!g) return;
  g.progress = Math.max(0, Math.min(100, (g.progress||0) + delta));
  await updateDoc(doc(db,'users',currentUser.uid,'goals',id), {progress:g.progress});
  if (g.progress === 100) toast('ğŸ‰ Goal completed!','ğŸ†');
  renderAll();
};

window.delGoal = async id => {
  if (!confirm('Delete this goal?')) return;
  goals = goals.filter(g => g.id !== id);
  await deleteDoc(doc(db,'users',currentUser.uid,'goals',id));
  renderAll(); toast('Goal removed','ğŸ—‘ï¸');
};

function renderGoalsIn(container, list, mini = false) {
  if (!list.length) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸš€</div><div class="empty-text">No goals yet.</div><button class="btn btn-primary" onclick="openGoalModal()">Set first goal</button></div>`;
    return;
  }
  container.innerHTML = list.map((g,i) => `
    <div class="goal-item">
      <div class="goal-header">
        <div class="goal-name">${CAT_ICONS[g.category]||'â­'} ${esc(g.name)}</div>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="goal-pct">${g.progress||0}%</div>
          ${!mini ? `<button style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:.75rem" onclick="openGoalModal('${g.id}')">âœ</button>
                     <button style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:.75rem" onclick="delGoal('${g.id}')">âœ•</button>` : ''}
        </div>
      </div>
      ${g.target ? `<div style="font-size:.72rem;color:var(--muted);margin-bottom:8px;font-family:'JetBrains Mono',monospace">Target: ${esc(g.target)}</div>` : ''}
      <div class="goal-progress-wrap"><div class="goal-progress-bar" style="width:${g.progress||0}%;background:${COLORS[i%COLORS.length]}"></div></div>
      ${!mini ? `<div class="goal-actions">
        <button class="btn-sm" onclick="updGoal('${g.id}',-10)">âˆ’10%</button>
        <button class="btn-sm" onclick="updGoal('${g.id}',10)">+10%</button>
        <button class="btn-sm" onclick="updGoal('${g.id}',25)">+25%</button>
        <button class="btn-sm" style="margin-left:auto" onclick="updGoal('${g.id}',${100-(g.progress||0)})">Complete âœ“</button>
      </div>` : ''}
    </div>`).join('');
}

/* â•â• INSIGHTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function calcStreak() {
  if (!journals.length) return 0;
  const uniq = [...new Set(journals.map(j => { const d=new Date(j.createdAt); return `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`; }))].sort().reverse();
  let streak = 0, cur = new Date();
  for (const s of uniq) {
    const [y,m,d] = s.split('-').map(Number);
    const entry = new Date(y,m,d);
    const diff = (new Date(cur.getFullYear(),cur.getMonth(),cur.getDate()) - entry) / 86400000;
    if (diff <= 1) { streak++; cur = entry; } else break;
  }
  return streak;
}

function renderInsights() {
  const streak = calcStreak();
  document.getElementById('insight-streak').textContent = streak;
  const cutoff = Date.now() - 7*86400000;
  const daily = {};
  journals.filter(j => new Date(j.createdAt) > cutoff).forEach(j => {
    const k = new Date(j.createdAt).toLocaleDateString();
    if (!daily[k]) daily[k] = [];
    daily[k].push(j.mood||3);
  });
  const td = document.getElementById('mood-trend-chart');
  const entries = Object.entries(daily);
  td.innerHTML = entries.length ? entries.map(([day,moods]) => {
    const avg = (moods.reduce((a,b)=>a+b,0)/moods.length).toFixed(1);
    return `<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
      <div style="width:70px;font-size:.68rem;color:var(--muted)">${day}</div>
      <div style="flex:1;background:var(--surface);border-radius:4px;height:20px;overflow:hidden">
        <div style="height:100%;background:linear-gradient(90deg,var(--rose),var(--amber),var(--accent),var(--green));width:${(avg/5)*100}%"></div>
      </div>
      <div style="width:28px;font-size:.8rem;font-weight:700;color:var(--accent)">${avg}</div>
    </div>`;
  }).join('') : `<div style="color:var(--muted);font-size:.8rem;padding:8px">No mood data yet.</div>`;

  const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const mc = {5:'var(--green)',4:'var(--teal)',3:'var(--accent)',2:'var(--amber)',1:'var(--rose)'};
  document.getElementById('mood-chart').innerHTML = days.map((d,i) => {
    const ent = journals.filter(j => new Date(j.createdAt).getDay() === (i+1)%7);
    const avg = ent.length ? Math.round(ent.reduce((s,e)=>s+e.mood,0)/ent.length) : 0;
    return `<div class="mood-row">
      <div class="mood-day-label">${d}</div>
      <div class="mood-bar-wrap"><div class="mood-bar" style="width:${avg*20}%;background:${mc[avg]||'var(--muted)'}"></div></div>
      <div class="mood-val">${avg||'â€”'}</div>
    </div>`;
  }).join('');

  const done = tasks.filter(t=>t.done).length, total = tasks.length;
  const avgM = journals.length ? (journals.reduce((s,j)=>s+j.mood,0)/journals.length).toFixed(1) : 'â€”';
  const top = [...goals].sort((a,b)=>b.progress-a.progress)[0];
  document.getElementById('activity-summary').innerHTML = `<div style="display:flex;flex-direction:column;gap:14px">
    ${[['ğŸ““','Journal Entries','Total: '+journals.length,journals.length,'var(--accent)'],
       ['âœ…','Task Completion',`${done} of ${total} done`,total?Math.round((done/total)*100)+'%':'0%','var(--green)'],
       ['ğŸ˜Š','Average Mood','Based on journals',avgM+'/5','var(--lavender)']
      ].map(([icon,label,sub,val,color]) =>
      `<div class="mood-row" style="align-items:center">
        <span style="font-size:1.2rem;width:28px">${icon}</span>
        <div style="flex:1"><div style="font-size:.78rem;font-weight:600;margin-bottom:2px">${label}</div><div style="font-size:.68rem;color:var(--muted)">${sub}</div></div>
        <div style="font-size:1.1rem;font-weight:800;color:${color}">${val}</div>
      </div>`).join('')}
    ${top ? `<div class="mood-row" style="align-items:center">
      <span style="font-size:1.2rem;width:28px">ğŸ†</span>
      <div style="flex:1"><div style="font-size:.78rem;font-weight:600;margin-bottom:2px">Top Goal</div><div style="font-size:.68rem;color:var(--muted)">${esc(top.name)}</div></div>
      <div style="font-size:1.1rem;font-weight:800;color:var(--amber)">${top.progress}%</div>
    </div>` : ''}
  </div>`;
}

/* â•â• FILTER JOURNALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.filterJournals = () => {
  const q = document.getElementById('journal-search').value.toLowerCase().trim();
  if (!q) { renderJournals('journal-list'); return; }
  const orig = journals;
  journals = journals.filter(e =>
    e.title?.toLowerCase().includes(q) ||
    e.content?.toLowerCase().includes(q) ||
    (e.tags||[]).some(t => t.toLowerCase().includes(q))
  );
  renderJournals('journal-list');
  journals = orig;
};

/* â•â• EXPORT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.exportAsJSON = () => {
  const blob = new Blob([JSON.stringify({journals,tasks,goals,exportedAt:new Date().toISOString(),user:currentUser?.email},null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `lifevault-backup-${Date.now()}.json`; a.click();
  toast('Backup downloaded!','ğŸ’¾');
};

/* â•â• RENDER ALL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAll() {
  const streak = calcStreak();
  document.getElementById('stat-entries').textContent = journals.length;
  document.getElementById('stat-tasks').textContent   = tasks.filter(t => t.done && new Date(t.createdAt) > new Date(Date.now()-7*86400000)).length;
  document.getElementById('stat-goals').textContent   = goals.filter(g => (g.progress||0) < 100).length;
  document.getElementById('stat-streak').textContent  = streak;
  document.getElementById('insight-streak').textContent = streak;
  if (journals.length) {
    const counts = {}; journals.forEach(j => { counts[j.mood] = (counts[j.mood]||0)+1; });
    const fav = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0];
    document.getElementById('stat-mood').textContent = M_EMOJI[fav] || 'ğŸ˜';
  }

  // â”€â”€ use new renderJournals(containerId, limit, isDash) â”€â”€
  renderJournals('dash-journal-list', 3, true);
  renderJournals('journal-list');

  const pending = tasks.filter(t => !t.done).slice(0,5);
  const dt = document.getElementById('dash-task-list');
  if (!pending.length) dt.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ‰</div><div class="empty-text">All tasks done!</div><button class="btn btn-primary" onclick="openTaskModal()">Add task</button></div>`;
  else renderTasksIn(dt, pending);

  renderTasksIn(document.getElementById('tasks-high'), tasks.filter(t=>t.priority==='high'));
  renderTasksIn(document.getElementById('tasks-med'),  tasks.filter(t=>t.priority==='med'));
  renderTasksIn(document.getElementById('tasks-low'),  tasks.filter(t=>t.priority==='low'||t.done));
  renderGoalsIn(document.getElementById('goals-list'), goals);
  renderGoalsIn(document.getElementById('dash-goals-list'), goals.slice(0,3), true);

  if (currentUser && document.getElementById('page-profile')?.classList.contains('active')) renderProfilePage();
  else applyProfileToUI();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMMUNITY FEED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function subscribeFeed() {
  if (feedUnsubscribe) return;
  const q = query(collection(db,'community_posts'), orderBy('createdAt','desc'), limit(60));
  feedUnsubscribe = onSnapshot(q, snap => {
    feedPosts = snap.docs.map(d => ({id:d.id,...d.data(), createdAt:d.data().createdAt?.toDate()}));
    renderFeed(); updateCommStats();
    const activePage = document.querySelector('.page.active')?.id;
    if (activePage !== 'page-community' && snap.docChanges().some(c=>c.type==='added')) {
      document.getElementById('new-posts-dot').style.display = 'inline-block';
    }
  }, () => {
    document.getElementById('feed-list').innerHTML = `<div class="loading-posts">Could not load feed. Check Firestore rules.</div>`;
  });
}

function updateCommStats() {
  document.getElementById('comm-stat-posts').textContent   = feedPosts.length;
  document.getElementById('comm-stat-members').textContent = new Set(feedPosts.map(p=>p.authorId)).size;
  document.getElementById('comm-stat-likes').textContent   = feedPosts.reduce((s,p)=>s+(p.likes?.length||0),0);
}

window.setComposerType = type => {
  composerType = type;
  document.querySelectorAll('.composer-type-btn').forEach(b => b.classList.toggle('active', b.dataset.type===type));
};

window.postThought = async () => {
  const text = document.getElementById('composer-text').value.trim();
  if (!text) { toast('Write something first!','âœï¸'); return; }
  try {
    await addDoc(collection(db,'community_posts'), {
      type:'thought', body:text, title:'',
      authorId:currentUser.uid, authorName:currentUser.displayName||'Anonymous',
      authorAvatar:currentUser.photoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName||'U')}&background=4f8ef7&color=fff`,
      likes:[], commentCount:0, createdAt:serverTimestamp()
    });
    document.getElementById('composer-text').value = '';
    toast('Posted to community! ğŸŒ','âœ¨');
  } catch(e) { toast('Error: '+e.message,'âŒ'); }
};

window.openShareModal = (type='journal') => {
  const body = document.getElementById('share-modal-body');
  if (type==='journal') {
    document.getElementById('share-modal-title').textContent = 'ğŸ““ Share a Journal Entry';
    const items = journals.slice(0,20);
    body.innerHTML = items.length
      ? `<p style="font-size:.8rem;color:var(--muted);margin-bottom:14px;font-family:'Newsreader',serif;font-style:italic">Choose an entry to share publicly.</p>
         <div class="share-modal-items">${items.map(e=>`
           <div class="share-item" onclick="shareJournal('${e.id}')">
             <span class="share-item-icon">${e.moodEmoji||'ğŸ““'}</span>
             <div class="share-item-info"><div class="share-item-title">${esc(e.title||'Untitled')}</div><div class="share-item-meta">${fmtDate(e.createdAt)}</div></div>
             <span style="color:var(--accent);font-size:.75rem;font-weight:600">Share â†—</span>
           </div>`).join('')}</div>`
      : `<div class="empty-state"><div class="empty-icon">ğŸ““</div><div class="empty-text">No journal entries yet.</div></div>`;
  }
  if (type==='task') {
    document.getElementById('share-modal-title').textContent = 'âœ… Share a Task';
    const items = tasks.slice(0,20);
    const PI = {high:'ğŸ”´',med:'ğŸŸ¡',low:'ğŸŸ¢'};
    body.innerHTML = items.length
      ? `<div class="share-modal-items">${items.map(t=>`
           <div class="share-item" onclick="shareTask('${t.id}')">
             <span class="share-item-icon">${PI[t.priority]||'âœ…'}</span>
             <div class="share-item-info"><div class="share-item-title">${esc(t.text)}</div><div class="share-item-meta">${t.priority} Â· ${t.done?'Done âœ“':'Pending'}</div></div>
             <span style="color:var(--green);font-size:.75rem;font-weight:600">Share â†—</span>
           </div>`).join('')}</div>`
      : `<div class="empty-state"><div class="empty-icon">âœ…</div><div class="empty-text">No tasks yet.</div></div>`;
  }
  if (type==='goal') {
    document.getElementById('share-modal-title').textContent = 'ğŸ¯ Share a Goal';
    const items = goals.slice(0,20);
    body.innerHTML = items.length
      ? `<div class="share-modal-items">${items.map(g=>`
           <div class="share-item" onclick="shareGoal('${g.id}')">
             <span class="share-item-icon">${CAT_ICONS[g.category]||'ğŸ¯'}</span>
             <div class="share-item-info"><div class="share-item-title">${esc(g.name)}</div><div class="share-item-meta">${g.progress||0}% Â· ${esc(g.target||'')}</div></div>
             <span style="color:var(--lavender);font-size:.75rem;font-weight:600">Share â†—</span>
           </div>`).join('')}</div>`
      : `<div class="empty-state"><div class="empty-icon">ğŸ¯</div><div class="empty-text">No goals yet.</div></div>`;
  }
  document.getElementById('share-modal').classList.add('open');
};

window.shareJournal = async id => {
  const e = journals.find(j=>j.id===id); if (!e) return;
  closeModal('share-modal');
  try {
    await addDoc(collection(db,'community_posts'), {
      type:'journal', title:e.title||'Untitled', body:e.content||'', mood:e.mood||3,
      moodEmoji:e.moodEmoji||'ğŸ˜', tags:e.tags||[], photoUrls:(e.photoUrls||[]).slice(0,3),
      authorId:currentUser.uid, authorName:currentUser.displayName||'Anonymous',
      authorAvatar:currentUser.photoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName||'U')}&background=4f8ef7&color=fff`,
      likes:[], commentCount:0, createdAt:serverTimestamp()
    });
    toast('Journal shared! ğŸŒ','ğŸ““'); navigate('community');
  } catch(e) { toast('Error: '+e.message,'âŒ'); }
};

window.shareTask = async id => {
  const t = tasks.find(t=>t.id===id); if (!t) return;
  closeModal('share-modal');
  const PI = {high:'ğŸ”´',med:'ğŸŸ¡',low:'ğŸŸ¢'};
  try {
    await addDoc(collection(db,'community_posts'), {
      type:'task', title:t.text, body:t.note||'', priority:t.priority, priorityIcon:PI[t.priority]||'âœ…', done:t.done||false,
      authorId:currentUser.uid, authorName:currentUser.displayName||'Anonymous',
      authorAvatar:currentUser.photoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName||'U')}&background=4f8ef7&color=fff`,
      likes:[], commentCount:0, createdAt:serverTimestamp()
    });
    toast('Task shared! ğŸŒ','âœ…'); navigate('community');
  } catch(e) { toast('Error: '+e.message,'âŒ'); }
};

window.shareGoal = async id => {
  const g = goals.find(g=>g.id===id); if (!g) return;
  closeModal('share-modal');
  try {
    await addDoc(collection(db,'community_posts'), {
      type:'goal', title:g.name, body:g.target||'', category:g.category, categoryIcon:CAT_ICONS[g.category]||'â­', progress:g.progress||0,
      authorId:currentUser.uid, authorName:currentUser.displayName||'Anonymous',
      authorAvatar:currentUser.photoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName||'U')}&background=4f8ef7&color=fff`,
      likes:[], commentCount:0, createdAt:serverTimestamp()
    });
    toast('Goal shared! ğŸŒ','ğŸ¯'); navigate('community');
  } catch(e) { toast('Error: '+e.message,'âŒ'); }
};

function renderFeed() {
  const container = document.getElementById('feed-list');
  let posts = [...feedPosts];
  if (currentFeedFilter !== 'all') {
    if (currentFeedFilter === 'mine') posts = posts.filter(p=>p.authorId===currentUser.uid);
    else posts = posts.filter(p=>p.type===currentFeedFilter);
  }
  if (!posts.length) {
    container.innerHTML = `<div class="feed-empty"><div class="empty-icon">ğŸŒ±</div><div class="empty-title">Nothing here yet</div><div class="empty-sub">Be the first to share something!</div></div>`;
    return;
  }
  container.innerHTML = posts.map(p => renderPostCard(p)).join('');
}

function renderPostCard(p) {
  const isOwn  = p.authorId === currentUser?.uid;
  const liked  = (p.likes||[]).includes(currentUser?.uid);
  const timeAgo = relativeTime(p.createdAt);
  const badgeClass = TYPE_BADGE_CLASS[p.type]||'badge-journal';
  const repostBadge = p.isRepost
    ? `<div style="font-family:'JetBrains Mono',monospace;font-size:.6rem;color:var(--teal);margin-bottom:10px;display:flex;align-items:center;gap:6px">ğŸ” reposted from <img src="${esc(p.originalAuthorAvatar||'')}" style="width:16px;height:16px;border-radius:50%;object-fit:cover"><span>${esc(p.originalAuthorName||'')}</span></div>` : '';

  let typeHtml = '';
  if (p.type === 'goal') {
    typeHtml = `<div class="post-goal-bar"><div class="post-goal-fill" style="width:${p.progress||0}%"></div></div>
      <div class="post-goal-meta"><span>${p.categoryIcon||'ğŸ¯'}</span><span>${p.progress||0}% complete</span></div>
      ${p.body ? `<div class="post-body" style="margin-top:10px">${esc(p.body)}</div>` : ''}`;
  } else if (p.type === 'task') {
    typeHtml = `<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <span>${p.priorityIcon||'âœ…'}</span>
        <span style="font-size:.72rem;font-family:'JetBrains Mono',monospace;color:var(--muted);text-transform:uppercase">${p.priority||''} priority</span>
        ${p.done?`<span style="font-size:.72rem;font-family:'JetBrains Mono',monospace;color:var(--green)">Â· Done âœ“</span>`:''}
      </div>
      ${p.body ? `<div class="post-body">${esc(p.body)}</div>` : ''}`;
  } else {
    const isLong = (p.body||'').length > 300;
    typeHtml = `<div class="post-body" id="post-body-${p.id}">${esc(p.body||'')}</div>
      ${isLong ? `<span class="post-read-more" onclick="toggleReadMore('${p.id}')">Read more â†“</span>` : ''}
      ${p.moodEmoji ? `<div style="margin-top:8px;font-size:.8rem;color:var(--muted);font-family:'JetBrains Mono',monospace">feeling ${p.moodEmoji}</div>` : ''}
      ${p.photoUrls?.length ? `<div class="post-photos">${p.photoUrls.map(u=>`<img src="${u}" class="post-photo" onclick="viewPhoto('${u}')">`).join('')}</div>` : ''}
      ${p.tags?.length ? `<div class="post-tags">${p.tags.map(t=>`<span class="tag" style="background:rgba(79,142,247,.12);color:var(--accent)">${esc(t)}</span>`).join('')}</div>` : ''}`;
  }

  return `<div class="post-card" id="post-card-${p.id}">
    <div class="post-header">
      <img src="${esc(p.authorAvatar||'')}" class="post-avatar" onerror="this.src='https://ui-avatars.com/api/?name=U&background=4f8ef7&color=fff'">
      <div class="post-meta">
        <div class="post-author">${esc(p.authorName||'Anonymous')} <span class="post-type-badge ${badgeClass}">${TYPE_BADGES[p.type]||p.type}</span>${isOwn?`<span style="font-family:'JetBrains Mono',monospace;font-size:.55rem;color:var(--muted);padding:2px 6px;border-radius:4px;background:var(--surface2)">you</span>`:''}</div>
        <div class="post-time">${timeAgo}</div>
      </div>
      ${isOwn?`<button class="post-delete-btn" onclick="deletePost('${p.id}')">ğŸ—‘ï¸</button>`:''}
    </div>
    ${p.title ? `<div class="post-title">${esc(p.title)}</div>` : ''}
    ${repostBadge}${typeHtml}
    <div class="post-actions">
      <button class="post-action-btn ${liked?'liked':''}" onclick="toggleLike('${p.id}')"><span class="heart-icon">${liked?'â¤ï¸':'ğŸ¤'}</span><span class="post-action-count">${(p.likes||[]).length||''}</span></button>
      <button class="post-action-btn" onclick="toggleComments('${p.id}')">ğŸ’¬ <span class="post-action-count" id="comment-count-${p.id}">${p.commentCount||0}</span></button>
      <button class="post-action-btn" onclick="repost('${p.id}')">ğŸ” <span class="post-action-count">${p.repostCount||''}</span></button>
    </div>
    <div class="comments-section" id="comments-${p.id}" style="display:none">
      <div id="comments-list-${p.id}"><div style="font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--muted);padding:8px">Loadingâ€¦</div></div>
      <div class="comment-input-row">
        <img src="${esc(currentUser?.photoURL||'https://ui-avatars.com/api/?name=U&background=4f8ef7&color=fff')}" style="width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid var(--border);flex-shrink:0">
        <input class="comment-input" id="comment-input-${p.id}" placeholder="Write a commentâ€¦" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();submitComment('${p.id}')}">
        <button class="comment-submit" onclick="submitComment('${p.id}')">â†µ</button>
      </div>
    </div>
  </div>`;
}

window.toggleReadMore = id => {
  const el = document.getElementById('post-body-'+id);
  const btn = el?.nextElementSibling;
  if (!el||!btn) return;
  el.classList.toggle('expanded');
  btn.textContent = el.classList.contains('expanded') ? 'Show less â†‘' : 'Read more â†“';
};

window.toggleLike = async postId => {
  const post = feedPosts.find(p=>p.id===postId); if (!post) return;
  const uid = currentUser.uid, liked = (post.likes||[]).includes(uid);
  try { await updateDoc(doc(db,'community_posts',postId), { likes: liked ? arrayRemove(uid) : arrayUnion(uid) }); }
  catch(e) { toast('Error: '+e.message,'âŒ'); }
};

window.deletePost = async postId => {
  if (!confirm('Delete this post?')) return;
  try { await deleteDoc(doc(db,'community_posts',postId)); toast('Post deleted','ğŸ—‘ï¸'); }
  catch(e) { toast('Error: '+e.message,'âŒ'); }
};

window.toggleComments = async postId => {
  const section = document.getElementById('comments-'+postId); if (!section) return;
  const isOpen = section.style.display !== 'none';
  section.style.display = isOpen ? 'none' : 'block';
  if (!isOpen) await loadComments(postId);
};

async function loadComments(postId) {
  const listEl = document.getElementById('comments-list-'+postId); if (!listEl) return;
  try {
    const snap = await getDocs(query(collection(db,'community_posts',postId,'comments'), orderBy('createdAt','asc')));
    const comments = snap.docs.map(d => ({id:d.id,...d.data(), createdAt:d.data().createdAt?.toDate()}));
    renderComments(postId, comments);
  } catch { listEl.innerHTML = `<div style="font-size:.72rem;color:var(--muted);padding:8px">Could not load comments.</div>`; }
}

function renderComments(postId, comments) {
  const listEl = document.getElementById('comments-list-'+postId); if (!listEl) return;
  if (!comments.length) { listEl.innerHTML = `<div style="font-family:'JetBrains Mono',monospace;font-size:.62rem;color:var(--muted);padding:8px 0">No comments yet.</div>`; return; }
  listEl.innerHTML = comments.map(c => `
    <div class="comment-item">
      <img src="${esc(c.authorAvatar||'')}" class="comment-avatar" onerror="this.src='https://ui-avatars.com/api/?name=U&background=4f8ef7&color=fff'">
      <div class="comment-bubble">
        <div class="comment-author"><span>${esc(c.authorName||'Anonymous')}</span>${c.authorId===currentUser?.uid?`<button class="comment-del" onclick="deleteComment('${postId}','${c.id}')">âœ•</button>`:''}</div>
        <div style="font-family:'JetBrains Mono',monospace;font-size:.58rem;color:var(--muted);margin-bottom:4px">${relativeTime(c.createdAt)}</div>
        <div class="comment-text">${esc(c.text)}</div>
      </div>
    </div>`).join('');
}

window.submitComment = async postId => {
  const input = document.getElementById('comment-input-'+postId);
  const text = input?.value.trim(); if (!text) return;
  input.value = '';
  try {
    await addDoc(collection(db,'community_posts',postId,'comments'), {
      text, authorId:currentUser.uid, authorName:currentUser.displayName||'Anonymous',
      authorAvatar:currentUser.photoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.displayName||'U')}&background=4f8ef7&color=fff`,
      createdAt:serverTimestamp()
    });
    await updateDoc(doc(db,'community_posts',postId), {commentCount:increment(1)});
    await loadComments(postId);
    const countEl = document.getElementById('comment-count-'+postId);
    if (countEl) countEl.textContent = parseInt(countEl.textContent||0)+1;
  } catch(e) { toast('Error: '+e.message,'âŒ'); }
};

window.deleteComment = async (postId, commentId) => {
  try {
    await deleteDoc(doc(db,'community_posts',postId,'comments',commentId));
    await updateDoc(doc(db,'community_posts',postId), {commentCount:increment(-1)});
    await loadComments(postId);
  } catch(e) { toast('Error: '+e.message,'âŒ'); }
};

window.repost = async postId => {
  const post = feedPosts.find(p=>p.id===postId); if (!post) return;
  if (post.authorId === currentUser.uid) { toast('Cannot repost your own post','âš ï¸'); return; }
  try {
    await addDoc(collection(db,'community_posts'), {
      ...post, id:undefined, isRepost:true,
      originalAuthorName:post.authorName, originalAuthorAvatar:post.authorAvatar,
      authorId:currentUser.uid, authorName:currentUser.displayName||'Anonymous',
      authorAvatar:currentUser.photoURL||'https://ui-avatars.com/api/?name=U&background=4f8ef7&color=fff',
      likes:[], commentCount:0, repostCount:0, createdAt:serverTimestamp()
    });
    await updateDoc(doc(db,'community_posts',postId), {repostCount:increment(1)});
    toast('Reposted! ğŸ”','âœ¨');
  } catch(e) { toast('Error: '+e.message,'âŒ'); }
};

window.filterFeed = (filter, btn) => {
  currentFeedFilter = filter;
  document.querySelectorAll('.feed-filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderFeed();
};

function relativeTime(date) {
  if (!date) return '';
  const diff = Date.now() - new Date(date).getTime();
  const mins = Math.floor(diff/60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins/60);
  if (hrs < 24) return `${hrs}h ago`;
  const days = Math.floor(hrs/24);
  if (days < 7) return `${days}d ago`;
  return new Date(date).toLocaleDateString('en-US',{month:'short',day:'numeric'});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROFILE SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadUserProfile() {
  if (!currentUser) return;
  try {
    const snap = await getDoc(doc(db,'users',currentUser.uid,'profile','data'));
    if (snap.exists()) { userProfile = snap.data(); }
    else {
      userProfile = {
        displayName: currentUser.displayName||'',
        username: (currentUser.displayName||'user').toLowerCase().replace(/[^a-z0-9_]/g,'').slice(0,20)||'user',
        bio:'', location:'', website:'',
        avatarUrl: currentUser.photoURL||'',
        coverGradient: COVER_PRESETS[0],
        joinedAt: new Date().toISOString(),
      };
      await setUserProfile(userProfile);
    }
    applyProfileToUI();
  } catch(e) { console.warn('Profile load:', e.message); }
}

async function setUserProfile(data) {
  if (!currentUser) return;
  await setDoc(doc(db,'users',currentUser.uid,'profile','data'), data, {merge:true});
}

function applyProfileToUI() {
  const p = userProfile;
  const av = p.avatarUrl || currentUser?.photoURL ||
    `https://ui-avatars.com/api/?name=${encodeURIComponent(p.displayName||'U')}&background=4f8ef7&color=fff`;
  document.getElementById('user-name').textContent = p.displayName || currentUser?.displayName || 'â€”';
  document.getElementById('user-avatar').src = av;
  document.getElementById('composer-avatar').src = av;

  const el = id => document.getElementById(id);
  if (el('profile-avatar-large'))      el('profile-avatar-large').src = av;
  if (el('profile-display-name'))      el('profile-display-name').textContent = p.displayName||'â€”';
  if (el('profile-username-display'))  el('profile-username-display').textContent = '@'+(p.username||'â€”');
  if (el('profile-bio-display'))       el('profile-bio-display').textContent = p.bio||'No bio yet.';
  if (el('profile-cover-display'))     el('profile-cover-display').style.background = p.coverGradient||COVER_PRESETS[0];

  const badges = [];
  if (journals.length >= 1)           badges.push({label:'ğŸ““ Writer',color:'rgba(79,142,247,.2)',border:'rgba(79,142,247,.4)'});
  if (tasks.filter(t=>t.done).length) badges.push({label:'âœ… Doer',color:'rgba(52,211,153,.15)',border:'rgba(52,211,153,.4)'});
  if (goals.length >= 1)              badges.push({label:'ğŸ¯ Goal-setter',color:'rgba(167,139,250,.15)',border:'rgba(167,139,250,.4)'});
  if (calcStreak() >= 3)              badges.push({label:'ğŸ”¥ On a streak',color:'rgba(251,191,36,.15)',border:'rgba(251,191,36,.4)'});
  if (el('profile-badges')) el('profile-badges').innerHTML = badges.map(b=>`<span class="profile-badge" style="background:${b.color};border-color:${b.border};color:var(--text)">${b.label}</span>`).join('');

  if (el('pstat-journals')) el('pstat-journals').textContent = journals.length;
  if (el('pstat-tasks'))    el('pstat-tasks').textContent    = tasks.length;
  if (el('pstat-goals'))    el('pstat-goals').textContent    = goals.length;
  if (el('pstat-posts'))    el('pstat-posts').textContent    = feedPosts.filter(p=>p.authorId===currentUser?.uid).length;

  const infoEl = el('profile-info-row');
  if (infoEl) {
    const parts = [];
    if (p.location) parts.push(`ğŸ“ ${esc(p.location)}`);
    if (p.website)  parts.push(`ğŸ”— <a href="${esc(p.website)}" target="_blank" style="color:var(--accent);text-decoration:none">${esc(p.website.replace(/^https?:\/\//,''))}</a>`);
    if (p.joinedAt) parts.push(`ğŸ—“ Joined ${new Date(p.joinedAt).toLocaleDateString('en-US',{month:'long',year:'numeric'})}`);
    infoEl.innerHTML = parts.join('<span style="margin:0 8px;opacity:.3">Â·</span>');
  }
}

function renderProfilePage() {
  applyProfileToUI();
  const myPosts = feedPosts.filter(p=>p.authorId===currentUser?.uid);
  const postsEl = document.getElementById('profile-my-posts');
  if (postsEl) {
    postsEl.innerHTML = myPosts.length
      ? myPosts.map(p=>renderPostCard(p)).join('')
      : `<div class="feed-empty" style="padding:32px"><div class="empty-icon">ğŸŒ</div><div class="empty-title">No posts yet</div><div class="empty-sub">Share something with the community!</div><button class="btn btn-primary" style="margin-top:16px" onclick="navigate('community')">Go to Community</button></div>`;
  }
}

window.openEditProfileModal = () => {
  const p = userProfile;
  document.getElementById('edit-fullname').value  = p.displayName||currentUser?.displayName||'';
  document.getElementById('edit-username').value  = p.username||'';
  document.getElementById('edit-bio').value       = p.bio||'';
  document.getElementById('edit-location').value  = p.location||'';
  document.getElementById('edit-website').value   = p.website||'';
  document.getElementById('edit-profile-modal').classList.add('open');
  setTimeout(() => document.getElementById('edit-fullname').focus(), 100);
};

window.saveProfile = async () => {
  const fullName = document.getElementById('edit-fullname').value.trim();
  const rawUser  = document.getElementById('edit-username').value.trim().toLowerCase().replace(/[^a-z0-9_]/g,'');
  if (!fullName) { toast('Name cannot be empty','âš ï¸'); return; }
  if (!rawUser)  { toast('Username cannot be empty','âš ï¸'); return; }
  userProfile = {...userProfile, displayName:fullName, username:rawUser,
    bio:document.getElementById('edit-bio').value.trim(),
    location:document.getElementById('edit-location').value.trim(),
    website:document.getElementById('edit-website').value.trim()};
  try { await setUserProfile(userProfile); applyProfileToUI(); closeModal('edit-profile-modal'); toast('Profile updated! âœ¨','ğŸ‘¤'); }
  catch(e) { toast('Error: '+e.message,'âŒ'); }
};

window.openAvatarModal = () => {
  selectedAvatarUrl = userProfile.avatarUrl||currentUser?.photoURL||'';
  const grid = document.getElementById('avatar-preset-grid');
  grid.innerHTML = AVATAR_PRESETS.map((url,i) =>
    `<img src="${url}" class="avatar-option ${selectedAvatarUrl===url?'selected':''}" onclick="selectAvatarPreset('${url}',this)" alt="Avatar ${i+1}">`
  ).join('');
  const fi = document.getElementById('avatar-upload');
  fi.value = '';
  fi.onchange = async e => {
    const file = e.target.files[0]; if (!file) return;
    toast('Compressingâ€¦','ğŸ“·');
    try { selectedAvatarUrl = await compressImageTo(file, 80*1024); toast('Avatar ready!','âœ…'); }
    catch { toast('Could not read image','âŒ'); }
  };
  document.getElementById('avatar-modal').classList.add('open');
};

window.selectAvatarPreset = (url, el) => {
  selectedAvatarUrl = url;
  document.querySelectorAll('.avatar-option').forEach(o=>o.classList.remove('selected'));
  el.classList.add('selected');
};

window.saveAvatar = async () => {
  if (!selectedAvatarUrl) { toast('Pick an avatar first','âš ï¸'); return; }
  userProfile.avatarUrl = selectedAvatarUrl;
  try { await setUserProfile(userProfile); applyProfileToUI(); closeModal('avatar-modal'); toast('Avatar updated!','ğŸ–¼'); }
  catch(e) { toast('Error: '+e.message,'âŒ'); }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COVER MODAL  â€”  hex-based gradient generator
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.openCoverModal = () => {
  selectedCoverData = { value: userProfile.coverGradient || COVER_PRESETS[0] };

  // Preset grid
  const grid = document.getElementById('cover-preset-grid');
  grid.innerHTML = COVER_PRESETS.map((grad, i) =>
    `<div class="cover-preset ${userProfile.coverGradient===grad?'selected':''}"
      style="background:${grad}" onclick="selectCoverPreset('${grad}',this)"></div>`
  ).join('');

  // Live preview
  document.getElementById('cover-live-preview').style.background = selectedCoverData.value;
  document.getElementById('hex-text-input').value = '';
  document.getElementById('hex-color-wheel').value = '#4f8ef7';

  // Sync color wheel â†’ text input â†’ live preview
  const wheel = document.getElementById('hex-color-wheel');
  const textIn = document.getElementById('hex-text-input');
  wheel.oninput = () => {
    textIn.value = wheel.value;
    previewHexGradient(wheel.value);
  };
  textIn.oninput = () => {
    const hex = textIn.value.trim();
    if (/^#[0-9a-fA-F]{6}$/.test(hex)) {
      wheel.value = hex;
      previewHexGradient(hex);
    }
  };

  document.getElementById('cover-modal').classList.add('open');
};

function hexToRgb(hex) {
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  return {r,g,b};
}

function darken(hex, factor) {
  const {r,g,b} = hexToRgb(hex);
  const d = v => Math.round(Math.max(0, v*factor)).toString(16).padStart(2,'0');
  return `#${d(r)}${d(g)}${d(b)}`;
}

function hexToGradient(hex) {
  // Build: very dark base â†’ mid tone of user color â†’ ultra dark
  const mid  = darken(hex, 0.55);  // 55% brightness of user color
  const dark = darken(hex, 0.18);  // very dark tint
  const ultra = darken(hex, 0.1);
  return `linear-gradient(135deg,${dark},${mid},${ultra})`;
}

function previewHexGradient(hex) {
  const grad = hexToGradient(hex);
  document.getElementById('cover-live-preview').style.background = grad;
  // Deselect presets
  document.querySelectorAll('.cover-preset').forEach(p=>p.classList.remove('selected'));
  selectedCoverData = { value: grad };
}

window.applyHexCover = () => {
  const textIn = document.getElementById('hex-text-input');
  const wheel  = document.getElementById('hex-color-wheel');
  let hex = textIn.value.trim();
  // Accept shorthand like #fff â†’ #ffffff
  if (/^#[0-9a-fA-F]{3}$/.test(hex)) {
    hex = '#' + hex[1]+hex[1]+hex[2]+hex[2]+hex[3]+hex[3];
  }
  if (!/^#[0-9a-fA-F]{6}$/.test(hex)) {
    // Fall back to color wheel
    hex = wheel.value;
  }
  previewHexGradient(hex);
  toast('Preview updated!','ğŸ¨');
};

window.selectCoverPreset = (grad, el) => {
  selectedCoverData = { value: grad };
  document.querySelectorAll('.cover-preset').forEach(p=>p.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('cover-live-preview').style.background = grad;
  document.getElementById('hex-text-input').value = '';
};

window.saveCover = async () => {
  if (!selectedCoverData) return;
  userProfile.coverGradient = selectedCoverData.value;
  try {
    await setUserProfile(userProfile);
    const cover = document.getElementById('profile-cover-display');
    if (cover) cover.style.background = selectedCoverData.value;
    closeModal('cover-modal');
    toast('Cover updated!','ğŸ–¼');
  } catch(e) { toast('Error: '+e.message,'âŒ'); }
};

/* â•â• IMAGE COMPRESSION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function compressImageTo(file, targetBytes) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = reject;
    reader.onload = ev => {
      const img = new Image();
      img.onerror = reject;
      img.onload = () => {
        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
        let maxDim = 400, quality = 0.85, result = '';
        for (let attempt = 0; attempt < 8; attempt++) {
          let w = img.width, h = img.height;
          if (w > h) { if (w > maxDim) { h = Math.round(h*maxDim/w); w = maxDim; } }
          else { if (h > maxDim) { w = Math.round(w*maxDim/h); h = maxDim; } }
          canvas.width = w; canvas.height = h;
          ctx.clearRect(0,0,w,h); ctx.drawImage(img,0,0,w,h);
          result = canvas.toDataURL('image/jpeg', quality);
          if (result.length*0.75 <= targetBytes) break;
          if (quality > 0.3) quality -= 0.12; else { maxDim = Math.round(maxDim*0.75); quality = 0.7; }
        }
        resolve(result);
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });
}

/* â•â• UTILS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.openEntryTypeModal = () => document.getElementById('entry-type-modal').classList.add('open');
window.closeModal = id => document.getElementById(id).classList.remove('open');
document.querySelectorAll('.modal-backdrop').forEach(m => m.addEventListener('click', e => {
  if (e.target === m) m.classList.remove('open');
}));
function fmtDate(d) {
  if (!d) return '';
  return new Date(d).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'});
}
function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
window.toast = (msg, icon='âœ¨') => {
  const t = document.createElement('div');
  t.className = 'toast';
  t.innerHTML = `<span>${icon}</span><span>${msg}</span>`;
  document.getElementById('toast-container').appendChild(t);
  setTimeout(() => { t.classList.add('out'); setTimeout(()=>t.remove(), 300); }, 3000);
};
</script>
</body>
</html>